# 提示词自定义与选择功能后端改造清单

本清单定义后端改造范围与任务项，使前端可显示官方提示词列表并支持用户自定义提示词；在生成脚本时按项目级选择渲染。动态占位符由后端注入，前端仅提示说明且禁止用户修改 `{{var}}` 语法。对必填占位符（如 `{{drama_name}}`、`{{plot_analysis}}`、`{{subtitle_content}}`）进行强约束与校验。
提供“官方提示词列表 + 用户自定义提示词”的双轨机制，前端可浏览官方提示词内容，亦可创建/编辑/选择用户提示词，并在生成脚本时生效。


## 目标
- [ ] 提供“官方 + 用户自定义”提示词双轨机制
- [ ] 前端可浏览官方提示词详情，用户可创建/编辑/删除自定义提示词
- [ ] 允许项目级选择使用的提示词；渲染时自动注入必要变量并校验
- [ ] 动态占位符统一规范与双重校验，明确必填变量

## 术语与占位符规范
- [ ] 前端展示占位符提示为 `{{var}}`，用户不可修改或删除占位符
- [ ] 后端存储与渲染统一转换为 `${var}`（`string.Template`）
- [ ] 必须占位符（短剧解说脚本生成场景）：
  - [ ] `{{drama_name}}`
  - [ ] `{{plot_analysis}}`
  - [ ] `{{subtitle_content}}`
- [ ] 保存与渲染阶段双重校验：缺失必填变量时报错

## 数据模型改造
- [ ] 用户模板存储文件（新增）：`backend/data/user_prompts.json`
  - 结构：`{ "templates": { "<id>": { id, name, category, description, template, variables, system_prompt, tags, version, origin: "user", enabled } } }`
  - 变量语法保存为内部格式 `${var}`，`variables` 列表同步维护
- [ ] 项目存储增加提示词选择（扩展 `Project`）
  - 字段：`prompt_selection: Dict[str, { type: "official"|"user", key_or_id: str }]`
  - 示例：`{"short_drama_narration:script_generation":{"type":"user","key_or_id":"user:my_template_id"}}`
  - 增加更新方法：`update_prompt_selection(project_id, feature_key, selection)`
- [ ] 不修改现有官方模块结构，兼容加载与渲染

## 后端 API 设计
- [ ] 列表与分类
  - [ ] `GET /api/prompts/categories` 返回分类列表
  - [ ] `GET /api/prompts?category=short_drama_narration` 返回该分类的提示词摘要列表（官方与用户），含 `id|key`、`name`、`origin`、`tags`
- [ ] 详情与预览
  - [ ] `GET /api/prompts/{key_or_id}` 返回完整模板详情（含 `system_prompt`、`template`、`variables`、`parameters`、`origin`、`version`）
  - [ ] `POST /api/prompts/{key_or_id}/render-preview` 使用示例变量进行渲染，返回 `messages`（不调用LLM）
- [ ] 用户模板管理
  - [ ] `POST /api/prompts` 创建用户模板（接收 `{{var}}`，后端转换为内部 `${var}`）
  - [ ] `PUT /api/prompts/{id}` 更新用户模板
  - [ ] `DELETE /api/prompts/{id}` 删除用户模板
  - [ ] `POST /api/prompts/validate` 校验模板占位符（缺失/多余/语法错误）
- [ ] 项目级选择
  - [ ] `POST /api/projects/{project_id}/prompts/select` 设置项目使用的提示词
  - [ ] `GET /api/projects/{project_id}/prompts/selection` 查看当前项目的选择映射

## 核心改造点（按文件）
- [ ] `modules/prompts/base.py`
  - [ ] 扩展占位符识别为双语法（`{{var}}` 与 `${var}`），渲染前统一转换为 `${var}`
  - [ ] 在 `render()` 内对缺失变量进行校验并抛错（已存在校验基础，补充双语法转换）
- [ ] `modules/prompts/prompt_manager.py`
  - [ ] 启动时加载 `backend/data/user_prompts.json` 并注册为 `PromptTemplate`（`origin="user"`）
  - [ ] `list_items` 增强返回项包含 `origin`、`name`；新增 `describe_item(key_or_id)`
  - [ ] 新增 `validate_template_placeholders(template_str, required_vars)` 返回缺失/多余占位符
  - [ ] `build_chat_messages()` 支持用户模板 `id` 与官方模块 `key` 两种输入
- [ ] 新增路由文件 `routes/prompts_routes.py`
  - [ ] 实现上述 CRUD、列表、详情、预览、校验接口
  - [ ] 与 `prompt_manager` 对接；对用户模板的读写由一个轻量级 Store 封装（内部读写 `backend/data/user_prompts.json`）
- [ ] `modules/projects_store.py`
  - [ ] 扩展 `Project` 数据类添加 `prompt_selection: Dict[str, Any] = Field(default_factory=dict)`
  - [ ] 添加/更新 `prompt_selection` 持久化读写逻辑（与现有 `_persist()` 兼容）
- [ ] `services/script_generation_service.py`
  - [ ] 在 `generate_script_json()` 与 `_generate_script_chunk()` 处加入“项目级提示词选择解析”
    - [ ] 用于替换硬编码键：当前键为 `short_drama_narration:script_generation`（参考：`backend/services/script_generation_service.py:402` 与 `601`）
    - [ ] 解析逻辑：若项目选择为用户模板，则调用 `prompt_manager.build_chat_messages(user_template_id, variables)`；否则使用官方默认键
  - [ ] 渲染失败或校验失败时进行安全回退到官方默认模板，并记录警告日志

## 必填变量说明（后端返回给前端）
- [ ] `drama_name`（短剧名称）
- [ ] `plot_analysis`（爆点分析/剧情概述，来源于 LLM 分析或历史缓存）
- [ ] `subtitle_content`（预处理后的字幕文本，含时间戳）
- [ ] 在 `GET /api/prompts/{key_or_id}/requirements` 中明确这些为“锁定变量”，前端需固定提示

## 校验与错误处理
- [ ] 保存校验：模板中缺失必填变量时拒绝保存（400）
- [ ] 渲染校验：构建消息前进行验证，缺失必填变量时抛错（并回退官方模板）
- [ ] 统一错误响应格式，便于前端提示

## 测试清单
- [ ] 模板双语法识别与归一化（`{{var}}` ⇄ `${var}`）
- [ ] 必填变量缺失/多余变量的校验用例
- [ ] 列表/详情/校验/预览接口的集成测试
- [ ] 项目级选择生效路径端到端测试（含用户模板与官方模板两种）
- [ ] 回退策略测试：用户模板不可用时是否正确回退
- [ ] 回归：未选择用户模板时生成脚本行为与旧版一致

## 迁移与兼容
- [ ] 官方模块保持 `${var}` 语法不变；前端展示层通过接口输出转换为 `{{var}}`
- [ ] 用户模板文件为新增，不影响现有流程
- [ ] 生成脚本默认继续使用官方模板，除非项目选择了用户模板

## 里程碑（建议）
- [ ] M1：占位符规范与双语法支持、校验器、PromptManager 扩展
- [ ] M2：Prompts 路由与项目级选择 API、ProjectsStore 字段扩展
- [ ] M3：ScriptGenerationService 接入选择解析与回退；联调前端
- [ ] M4：测试与文档完善（接口说明、必填变量规则）

## 参考代码位置
- [ ] 官方短剧解说脚本模板占位符：`backend/modules/prompts/short_drama_narration/script_generation.py:23, 29-45`
- [ ] 构建消息调用点（需改造接入选择解析）：
  - [ ] `backend/services/script_generation_service.py:402-459`
  - [ ] `backend/services/script_generation_service.py:601-627`
- [ ] 提示词基础渲染逻辑：`backend/modules/prompts/base.py:65-80`
- [ ] 提示词管理器：`backend/modules/prompts/prompt_manager.py`
