# 字幕提取与脚本生成解耦前端改造开发清单

## 范围与目标（仅前端）
- 将“字幕提取（ASR）”从“生成脚本”按钮中拆分为独立前端操作入口
- “提取字幕”完成后，前端渲染可编辑字幕，并支持提交用户修改后的字幕到后端
- 前端根据后端提供的字幕元信息（来源/状态/是否被用户修改）实现按钮禁用与提示文案
- “生成解说脚本”强制依赖“已有字幕”，前端在按钮层面做预校验，并正确呈现后端 400/409 错误
- “提取字幕”全流程接入现有 WebSocket 机制，展示进度条与日志（与 generate_script 一致体验）

## 当前前端现状（作为改造依据）
- 字幕入口位于高级配置区：`components/projectEdit/SubtitleUploader.tsx`（仅：上传/删除/进度条）
- 生成脚本入口位于项目操作区：`pages/ProjectEditPage.tsx` 调用 `useProjectDetail().generateScript()`
  - 请求仍会传 `subtitle_path`（历史兜底）
  - 页面通过 `wsClient` 监听 `scope="generate_script"` 消息更新进度与日志
- 项目类型 `types/project.ts` 仅包含 `subtitle_path`，缺少字幕来源/状态/用户修改标记等字段
- `services/projectService.ts` 仅实现了上传/删除字幕相关方法，没有“提取字幕/获取字幕/保存字幕”的 API 封装

## 后端契约（前端需要对齐）

### 新增接口
- `POST /api/projects/{project_id}/extract-subtitle`（body: `{ force?: boolean }`）
  - 成功返回：`{ segments, subtitle_meta }`
  - 可能报错：
    - 409：已上传字幕、正在提取中、字幕已被用户修改且未 force
    - 400：无视频、视频不存在、ASR 不可用等
- `GET /api/projects/{project_id}/subtitle`
  - 成功返回：`{ segments, subtitle_meta }`
  - 404：字幕不存在或文件不存在
- `POST /api/projects/{project_id}/subtitle`
  - body 支持二选一：
    - `{ segments: Array<{ id?: string, start_time: number, end_time: number, text: string }> }`
    - 或 `{ content: string }`（压缩行格式全文）
  - 成功返回：`{ segments, subtitle_meta }`

### WebSocket 进度事件
- `scope="extract_subtitle"`，消息结构与 `generate_script` 一致：
  - `type: "progress" | "completed" | "error"`
  - `project_id`
  - `phase`、`message`、`progress`（0~100）

### 项目字段（Project）
- `subtitle_path?: string`
- `subtitle_source?: null | "user" | "extracted"`
- `subtitle_status?: null | "none" | "extracting" | "ready" | "failed"`
- `subtitle_updated_by_user?: boolean`
- `subtitle_updated_at?: string | null`
- `subtitle_format?: string | null`（例如 `"compressed_srt_v1"`）

## 前端类型与数据模型改造

### 1) 扩展 Project 类型
- 文件：`frontend/src/types/project.ts`
- 任务：
  - 在 `Project` 中补齐字幕字段（见“后端契约”）
  - 视需要扩展 `UpdateProjectRequest`（仅当前端会直接更新这些字段；通常不需要）

### 2) 新增字幕相关类型
- 文件建议：`frontend/src/types/subtitle.ts`（或放在 `types/project.ts` 同文件也可）
- 建议类型：
  - `SubtitleSegment`
  - `SubtitleMeta`
  - `ExtractSubtitleResult` / `GetSubtitleResult` / `SaveSubtitleResult`
  - `SaveSubtitlePayload`
- 要点：
  - `SubtitleSegment` 与脚本段 `ScriptSegment` 字段相近，但语义不同，建议单独建类型，避免混用

## services 层改造（projectService）

### 3) 新增 API 封装
- 文件：`frontend/src/services/projectService.ts`
- 新增方法建议：
  - `extractSubtitle(projectId: string, force?: boolean)`
  - `getSubtitle(projectId: string)`
  - `saveSubtitle(projectId: string, payload: SaveSubtitlePayload)`
- 统一错误提示解析规则：
  - 复用 `ApiClient.request()` 的错误解析风格（优先 detail/message）
  - 与现有 `uploadSubtitle()` 的 XHR 错误解析保持一致体验

## hooks 层改造（useProjectDetail）

### 4) 暴露字幕相关操作与状态
- 文件：`frontend/src/hooks/useProjects.ts`
- 新增返回项建议：
  - `extractSubtitle(force?: boolean): Promise<void>`
  - `fetchSubtitle(): Promise<{ segments; meta } | null>`
  - `saveSubtitle(payload): Promise<void>`
  - `subtitleSegments` / `subtitleMeta`（可选：也可交由页面 state 管理）
  - `extractingSubtitle`、`extractSubtitleProgress`（或复用全局 loading，但建议独立）
- 关键行为：
  - `extractSubtitle` 成功后应刷新项目详情（更新 `subtitle_*` 字段）
  - `saveSubtitle` 成功后应刷新项目详情，并同步本地编辑状态
  - 对 409 错误做明确 toast（避免用户误以为是网络问题）

## 页面与组件改造（ProjectEditPage / SubtitleUploader）

### 5) 新增“提取字幕”交互入口
- 页面：`frontend/src/pages/ProjectEditPage.tsx` 或 `components/projectEdit/AdvancedConfigSection.tsx`
- 交互要求：
  - 当 `subtitle_source === "user"` 且 `subtitle_path` 存在：
    - 禁用“提取字幕”，提示“已上传字幕，需先删除才能提取”
  - 当 `subtitle_status === "extracting"`：
    - 禁用“提取字幕/生成脚本”，显示“提取中”
  - 当 `subtitle_updated_by_user === true`：
    - “提取字幕”点击时弹窗二次确认（或提供开关/复选框 `force`）
  - 无 `project.video_path` 时：
    - 禁用“提取字幕”，提示“请先上传视频”

### 6) 接入 extract_subtitle 的 WebSocket 进度与日志
- 位置建议：`ProjectEditPage.tsx` 仿照 `generate_script` 的监听实现
- 需求：
  - 新增一组 state：
    - `subtitleExtractProgress`、`subtitleExtractLogs`、`extractingSubtitle`
  - 监听规则：
    - `scope === "extract_subtitle" && project_id === 当前项目`
  - 完成/失败时收敛：
    - `completed`：自动触发 `refreshProject()` + 拉取一次 `GET /subtitle`（用于立即渲染）
    - `error`：toast + 停止 loading

### 7) 字幕渲染与编辑能力（最小可用实现）
- 推荐最小方案（先跑通链路）：
  - 使用可滚动列表渲染 `segments`（展示开始/结束时间与文本）
  - 每段提供 `textarea` 或 `input` 编辑 `text`
  - 提供按钮：
    - “保存字幕”：`POST /subtitle`（使用 `segments` 方式提交）
    - “重新加载”：`GET /subtitle`
- 进阶方案（可选）：
  - 提供“压缩行格式”原文编辑模式（提交 `content`）
  - 支持快捷合并/拆分字幕段、批量替换、过滤空段

### 8) 生成脚本按钮的前端预校验
- 位置：`ProjectEditPage.tsx` 的 `handleGenerateScript`
- 规则：
  - `subtitle_status !== "ready"` 或 `!subtitle_path`：直接提示“请先提取字幕或上传字幕”，不发请求
  - 同时保留后端错误兜底提示（因为字幕文件也可能被手动删除）

## UI 文案与状态展示建议
- 字幕状态 Badge：
  - `user`：已上传
  - `extracted`：已提取
  - `extracting`：提取中（显示进度）
  - `failed`：提取失败（引导查看日志）
  - `updated_by_user`：已编辑（提示“提取将覆盖修改内容”）
- 按钮区建议：
  - 提取字幕（主按钮）
  - 上传字幕（次按钮）
  - 删除字幕（危险按钮）
  - 保存字幕（主按钮，编辑区内）

## 自测清单（前端手工验证）
- 基础链路：
  - 上传视频 → 点击“提取字幕” → 看到进度与日志 → 成功后出现字幕列表
  - 编辑任意字幕段 → 点击“保存字幕” → 刷新页面后字幕仍为修改内容
  - 点击“生成脚本” → 生成脚本成功（WS 进度正常）
- 规则校验：
  - 上传字幕后：提取字幕按钮禁用，提示正确；删除字幕后可再次提取
  - 字幕提取中：按钮禁用与进度显示正确；WS 断开重连后状态可恢复（以项目字段为准）
  - 编辑字幕后：提取字幕需要 force/二次确认，否则提示“会覆盖修改”
- 错误处理：
  - 触发后端 409：前端 toast 能展示后端 detail
  - 触发后端 400：前端能提示“请先上传视频/ASR 不可用”等

