# 用户数据目录改造清单（backend/data 与 backend/config）

目标：将 backend/data 与 backend/config 的所有读写改为“用户数据目录”路径，保证用户数据与配置存放在系统推荐位置并可持久化。参考路径定义与 app_settings.json：
- macOS：~/Library/Application Support/SuperAutoCutVideo
- Windows：%LOCALAPPDATA%/SuperAutoCutVideo
- Linux：$XDG_DATA_HOME/SuperAutoCutVideo 或 ~/.local/share/SuperAutoCutVideo
- 配置文件示例：config/app_settings.json（参见 [storage_routes.py](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/backend/routes/storage_routes.py#L9-L23)）

用户数据目录内约定：
- config/：各类配置 JSON（模型、TTS、剪映路径、提示词配置等）
- data/：业务数据 JSON（projects.json、user_prompts.json 等）
- uploads/：上传与运行期缓存（由 app_settings.json 的 uploads_root 管理）

---

## 一、需要改造的代码位置（逐项清单）

- 数据文件
  - ProjectsStore 默认存储路径
    - 现状：backend/data/projects.json
    - 修改：改为 用户数据目录/data/projects.json
    - 位置与引用：
      - [projects_store.py:L54-L62](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/backend/modules/projects_store.py#L54-L62)
    - 变更点：初始化时 `backend_dir / "data"` 替换为 `user_data_dir() / "data"`，并保持 mkdir(parents=True, exist_ok=True)
  - 提示词路由存储文件
    - 现状：backend/data/user_prompts.json
    - 修改：改为 用户数据目录/data/user_prompts.json
    - 位置与引用：
      - [prompts_routes.py:L44-L47](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/backend/routes/prompts_routes.py#L44-L47)
    - 变更点：`_store_path()` 内 `backend_dir / "data"` 替换为 `user_data_dir() / "data"`
  - 提示词管理器用户模板加载
    - 现状：backend/data/user_prompts.json
    - 修改：改为 用户数据目录/data/user_prompts.json
    - 位置与引用：
      - [prompt_manager.py:L314-L321](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/backend/modules/prompts/prompt_manager.py#L314-L321)
    - 变更点：`store_path = backend_dir / "data" / "user_prompts.json"` 替换为 `user_data_dir() / "data" / "user_prompts.json"`

- 配置文件
  - 文案生成模型配置
    - 现状：backend/config/content_model_config.json
    - 修改：改为 用户数据目录/config/content_model_config.json
    - 位置与引用：
      - [content_model_config.py:L54-L60](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/backend/modules/config/content_model_config.py#L54-L60)
  - 视频分析模型配置
    - 现状：backend/config/video_model_config.json
    - 修改：改为 用户数据目录/config/video_model_config.json
    - 位置与引用：
      - [video_model_config.py:L54-L60](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/backend/modules/config/video_model_config.py#L54-L60)
  - TTS 引擎配置
    - 现状：backend/config/tts_config.json
    - 修改：改为 用户数据目录/config/tts_config.json
    - 位置与引用：
      - [tts_config.py:L56-L62](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/backend/modules/config/tts_config.py#L56-L62)
  - 剪映草稿路径配置
    - 现状：backend/config/jianying_config.json
    - 修改：改为 用户数据目录/config/jianying_config.json
    - 位置与引用：
      - [jianying_config.py:L19-L27](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/backend/modules/config/jianying_config.py#L19-L27)
  - 提示词静态配置（若存在）
    - 现状：backend/config/prompts.json
    - 修改：改为 用户数据目录/config/prompts.json
    - 位置与引用：
      - [prompt_manager.py:L78-L83](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/backend/modules/prompts/prompt_manager.py#L78-L83)

---

## 二、统一路径辅助与依赖关系调整

- 新增共享路径工具模块（建议）：`backend/modules/path_utils.py` 或 `backend/modules/app_paths.py`
  - 提供：
    - `data_base_dir()`：与 [storage_routes.py:L9-L17](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/backend/routes/storage_routes.py#L9-L17) 同等行为
    - `user_config_dir()`：`data_base_dir() / "config"`
    - `user_data_dir()`：`data_base_dir() / "data"`
    - `app_settings_file()`：`user_config_dir() / "app_settings.json"`（参考 [storage_routes.py:L19-L23](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/backend/routes/storage_routes.py#L19-L23)）
    - `uploads_dir()`：读取 `SACV_UPLOADS_DIR` 或 `data_base_dir() / "uploads"`（与 [main.py:get_app_paths](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/backend/main.py#L121-L174) 保持一致）
  - 所有使用 `backend_dir / "data"` 与 `backend_dir / "config"` 的位置改为依赖该工具模块，避免从模块直接引用路由中的私有函数。

---

## 三、启动迁移与首次运行拷贝

- 在后端启动阶段（get_app_paths 之后）或独立初始化模块中执行以下迁移检查：
  - 若用户 `config/` 下缺少以下文件，则从仓库 `backend/config/` 拷贝默认模板：
    - content_model_config.json、video_model_config.json、tts_config.json、jianying_config.json、prompts.json（若存在）
  - 若用户 `data/` 下缺少以下文件，则从仓库 `backend/data/` 拷贝现有数据（若存在）：
    - projects.json、user_prompts.json
  - 需确保父目录 `mkdir(parents=True, exist_ok=True)`，并在只读或失败场景返回可理解的日志与提示。

---

## 四、路由与服务影响面验证

- 路由层面
  - tts_routes、video_model_routes、jianying_config_routes、project_routes 通过各 Manager 读写配置与数据，无需更改调用接口；但需要验证新的默认路径下的读写权限与热更新是否正常。
- 服务层面
  - 与 uploads 相关的服务已通过 app_settings.json 管理，保持现有实现；仅需确保 `SACV_UPLOADS_DIR` 在启动时正确设置（参见 [main.py:get_app_paths](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/backend/main.py#L121-L174) 与 `app.mount("/uploads", ...)`）。

---

## 五、测试与验证项

- 路径改造单元/集成测试：
  - user_config_dir()/user_data_dir() 存取读写正常（跨平台）
  - 首次运行迁移拷贝成功（仓库默认 → 用户目录）
  - projects.json 与 user_prompts.json 的CRUD操作在新路径下正常
  - 各配置管理器（content/video/tts/jianying）的加载、保存与激活流程正常
  - 提示词管理器同时加载用户模板与静态模板的行为正常
  - uploads 根目录变更后，视频/音频缓存与输出路径工作正常

---

## 六、文档与代码提示更新

- 清理或更新任何仍指向 `backend/config` 与 `backend/data` 的内部文档或字符串常量
  - 示例：后端文档 [提示词自定义与选择功能后端改造清单.md](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/backend/docs/提示词自定义与选择功能后端改造清单.md#L23) 中的路径说明需要同步为用户数据目录路径
- 后续开发注意：
  - 仓库目录 `backend/config` 与 `backend/data` 仅作为默认模板/初始数据来源，避免直接写入仓库路径

---

## 七、参考实现入口

- 用户数据目录路径定义与 app_settings.json：
  - [storage_routes.py:L9-L23](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/backend/routes/storage_routes.py#L9-L23)
  - [main.py:get_app_paths](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/backend/main.py#L121-L174)

