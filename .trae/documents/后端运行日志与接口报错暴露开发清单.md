# 后端运行日志与接口报错暴露开发清单

## 目标
- 将后端运行过程（服务日志、进度事件、接口报错）以“命令行风格日志流”的形式提供给前端展示
- 前端刷新后仍可回看历史日志与错误内容
- 统一消息结构，便于前端做高亮（error/warn/info）、过滤（按项目/范围）、搜索与复制

## 日志消息结构（后端统一输出）
- `id`: number（单调递增，游标）
- `timestamp`: string（ISO-like）
- `type`: string（`log` / `progress` / `error` / `success` / `ws_text` 等）
- `scope`: string（例如 `server_log` / `generate_script` / `generate_video` / `merge_videos` / `http_exception`）
- `project_id`: string | null
- `message` / `detail` / `error`: string（已做基础脱敏）
- `channel`: string（`global` 或 `project:{project_id}`）

## 接口清单

### 全局日志（服务级）
- `GET /api/logs`
  - Query:
    - `after_id`(可选): number
    - `limit`(可选): 1~2000，默认 200
  - 返回：`items` + `next_after_id`
- `GET /api/logs/stream`（SSE）
  - Query:
    - `after_id`(可选): number
  - 行为：先回放最近日志，再持续推送新增日志
- `POST /api/logs/clear`
  - 行为：清空全局日志历史

### 项目日志（按 project_id）
- `GET /api/projects/{project_id}/logs`
  - Query:
    - `after_id`(可选): number
    - `limit`(可选): 1~2000，默认 200
  - 返回：`items` + `next_after_id`
- `GET /api/projects/{project_id}/logs/stream`（SSE）
  - Query:
    - `after_id`(可选): number
  - 行为：先回放最近日志，再持续推送新增日志
- `POST /api/projects/{project_id}/logs/clear`
  - 行为：清空该项目日志历史

### 现有 WebSocket（兼容）
- `GET ws://{host}:{port}/ws`
  - 行为：服务端会广播 JSON 事件；当前已将广播内容写入日志持久化（用于刷新后回放）

## 前端接入建议（命令行风格）
- 初次进入“监控/日志”页：
  - 调 `GET /api/logs?limit=200`（或项目页调 `GET /api/projects/{id}/logs?limit=200`）回放历史
  - 将 `next_after_id` 存起来作为游标
- 实时订阅：
  - 优先用 SSE：`GET /api/logs/stream?after_id={next_after_id}`
  - 收到消息后追加到日志列表，并更新 `next_after_id`
- UI 表现：
  - `type=error` 用红色/高亮
  - `scope` 作为“命令行前缀”（例如 `[generate_video] ...`）
  - 提供复制、清空、暂停滚动、过滤（scope/project_id/level）能力

## 开发验证清单
- 后端：
  - 触发一个已知报错接口，确认 `/api/logs` 能看到 `http_exception` 或 `unhandled_exception` 记录
  - 触发一个项目流程（生成脚本/合并/生成视频），确认 `/api/projects/{id}/logs` 能看到对应 `scope` 事件
  - 刷新前端页面后，历史日志可通过 `GET .../logs` 回放
  - SSE 长连接稳定：断线后可用 `after_id` 继续续订不丢日志
- 前端：
  - “监控/日志”页实现 tail 效果（自动滚动到底部，可暂停）
  - 支持按项目切换，日志列表不串台（channel 或 project_id 过滤）
  - 支持清空（调用 clear 接口）并立即更新 UI

