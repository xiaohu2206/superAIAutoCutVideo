# 字幕提取与脚本生成解耦后端改造开发清单

## 范围与目标（仅后端）
- 将“字幕提取（ASR）”从现有 `generate-script` 流程中拆分为独立后端接口
- “提取字幕”完成后，后端返回结构化字幕给前端渲染，并支持前端提交用户修改后的字幕
- 后端能够判断当前字幕来源：用户上传 vs 系统提取，并据此限制“提取字幕”能力
- “生成解说脚本”在后端侧强制依赖“已有字幕”（来自提取或上传），不再隐式触发 ASR
- “提取字幕”全流程需要与现有 WebSocket 机制一致的进度事件（用于进度条与日志）

## 现状梳理（作为改造依据）
- `POST /api/projects/generate-script` 当前流程包含两段能力：
  - 若项目/请求提供字幕文件则跳过 ASR；否则会提取音频并调用 ASR 生成字幕，再用大模型生成脚本
  - WebSocket 广播 `scope=generate_script` 的 `progress/completed/error`
- `POST /api/projects/{project_id}/upload/subtitle` 会把 SRT 压缩后保存到 `uploads/subtitles`，并更新 `project.subtitle_path`
- 项目模型仅存 `subtitle_path`，缺少“字幕来源/状态/是否被用户修改”等元信息，无法支持“用户上传字幕则禁用提取字幕”的规则判定

## 数据结构改造（ProjectsStore / Project）

### 需要新增的项目字段（建议）
- `subtitle_source`: `null | "user" | "extracted"`
  - `user`: 通过 `upload/subtitle` 上传得到
  - `extracted`: 通过“提取字幕”接口提取得到（ASR）
- `subtitle_status`: `null | "none" | "extracting" | "ready" | "failed"`
  - 用于前端禁用按钮、后端校验依赖关系、以及恢复中间状态
- `subtitle_updated_by_user`: `bool`
  - 前端提交“修改字幕”后置为 `true`（不改变 `subtitle_source`）
- `subtitle_updated_at`: `string | null`（ISO-like）
  - 记录最近一次字幕内容更新（提取/上传/保存修改）时间
- （可选）`subtitle_format`: `null | "compressed_srt_v1"`
  - 目前后端已存在压缩行格式：`[HH:MM:SS,mmm-HH:MM:SS,mmm] text`

### 需要同步更新的位置
- `backend/modules/projects_store.py`
  - `Project` 增加字段默认值（保证旧 projects.json 可加载）
  - `update_project()` 允许更新新增字段
- `backend/routes/project_routes.py`
  - 创建/删除字幕、上传字幕、提取字幕、保存字幕时更新字段一致性

## 字幕数据格式设计（后端对前端输出）

### 存储格式（后端内部）
- 统一存为压缩行格式（与现有 `compress_srt/parse_srt` 兼容）：
  - 每行：`[HH:MM:SS,mmm-HH:MM:SS,mmm] 文本`
- 存储路径仍落在 `uploads/subtitles/`，并以 `to_web_path()` 写入 `project.subtitle_path`

### API 返回格式（供前端渲染/编辑）
- 结构化字幕段（建议字段保持与现有 `parse_srt()` 输出一致，便于复用）：
  - `segments: Array<{ id: string, start_time: number, end_time: number, text: string, subtitle: string }>`
- 额外返回字幕元信息（用于 UI 规则与状态展示）：
  - `subtitle_meta: { file_path: string | null, source: string | null, status: string | null, updated_by_user: boolean, updated_at: string | null, format?: string }`

## 接口改造清单（后端）

### 1) 新增：提取字幕
- `POST /api/projects/{project_id}/extract-subtitle`
  - 目标：仅做字幕提取（含必要的音频提取与 ASR），完成后把字幕保存到项目并返回结构化字幕
  - 请求体（建议）：
    - `force?: boolean`（默认 false）
      - 用于“已存在 extracted 字幕但需要重提”的场景；若 `subtitle_source=user` 则无论 `force` 与否都拒绝
  - 核心校验规则：
    - 项目不存在：404
    - 无有效 `video_path` 或文件不存在：400
    - `subtitle_source=user && subtitle_path 存在`：409（提示“已上传字幕，无法提取；请先删除字幕”）
    - `subtitle_status=extracting`：409（提示“正在提取中”）
    - `subtitle_updated_by_user=true && !force`：409（提示“字幕已被修改，若需覆盖请传 force=true”）
  - 行为要求：
    - 生成的字幕必须持久化：写入 `uploads/subtitles/`，并更新 `project.subtitle_path`
    - 更新项目字段：
      - `subtitle_source="extracted"`
      - `subtitle_status="ready"`（出错则 `"failed"`）
      - `subtitle_updated_by_user=false`（重提/首次提取时）
      - `subtitle_updated_at=now`
    - 返回 `segments + subtitle_meta`
  - WebSocket 进度：
    - 广播 `scope="extract_subtitle"` 的 `progress/completed/error`（详见“进度事件约定”）

### 2) 新增：获取字幕（用于进入页面/刷新渲染）
- `GET /api/projects/{project_id}/subtitle`
  - 目标：让前端在进入编辑页时拉取当前字幕并渲染
  - 核心校验规则：
    - 项目不存在：404
    - `subtitle_path` 不存在或文件不存在：404（或 200 返回空，二选一；建议 404）
  - 行为要求：
    - 从 `project.subtitle_path` 读取文件并解析为 `segments`
    - 返回 `segments + subtitle_meta`

### 3) 新增：保存字幕（用户修改后提交）
- `POST /api/projects/{project_id}/subtitle`
  - 目标：接收前端编辑结果并落盘，保证后续生成脚本使用的是“用户最终确认字幕”
  - 请求体（建议二选一；可同时支持）：
    - `segments: Array<{ id?: string, start_time: number, end_time: number, text: string }>`
    - 或 `content: string`（压缩行格式全文；由前端直接提交）
  - 校验规则（建议）：
    - `segments` 非空、时间戳合法（`start_time < end_time`、非负、单调不要求但建议排序）
    - 文本长度上限与段数上限（防止异常 payload）
  - 行为要求：
    - 将 `segments/content` 统一序列化为压缩行格式写回字幕文件
    - 若项目原先无 `subtitle_path`：
      - 新建 `uploads/subtitles/{project_id}_subtitle_edit_{ts}.srt` 并写入
    - 更新项目字段：
      - `subtitle_status="ready"`
      - `subtitle_updated_by_user=true`
      - `subtitle_updated_at=now`
      - `subtitle_source`：
        - 若当前为 `user` 保持 `user`
        - 若当前为 `extracted` 保持 `extracted`
        - 若为空（理论上不应发生）按来源场景补齐（默认 `extracted` 或直接拒绝）
    - 返回 `segments + subtitle_meta`

### 4) 兼容改造：上传字幕（标记来源）
- `POST /api/projects/{project_id}/upload/subtitle`
  - 增强点：
    - 上传成功后必须设置：
      - `subtitle_source="user"`
      - `subtitle_status="ready"`
      - `subtitle_updated_by_user=false`（上传视为最终输入，但也可以允许后续编辑再置 true）
      - `subtitle_updated_at=now`
    - 若之前存在 `subtitle_source="extracted"` 且字幕文件不同：
      - 允许覆盖（产品上是合理的“用户上传优先”）
      - 若要删除旧文件：作为可选增强（避免磁盘增长）

### 5) 兼容改造：删除字幕（清理元信息）
- `POST /api/projects/{project_id}/delete/subtitle`
  - 增强点：
    - 删除成功/失败均要将项目字幕字段归零：
      - `subtitle_path=null`
      - `subtitle_source=null`
      - `subtitle_status="none"`（或 null）
      - `subtitle_updated_by_user=false`
      - `subtitle_updated_at=now`（或置空，二选一）
    - 删除后应允许再次“提取字幕”

### 6) 改造：生成解说脚本（强制依赖字幕，不再触发 ASR）
- `POST /api/projects/generate-script`
  - 强制校验：
    - `project.subtitle_status=="ready"` 且 `subtitle_path` 文件存在
    - 否则 400，提示“请先提取字幕或上传字幕”
  - 行为调整（拆分后）：
    - 移除/跳过 ASR、音频提取相关逻辑（这些应由“提取字幕”完成）
    - 仍保留 `scope=generate_script` 的进度广播（大模型分析字幕、生成脚本、保存等）
  - 兼容策略：
    - 请求体中的 `subtitle_path` 可继续保留为兜底，但最终以 `project.subtitle_path` 为准（避免前端传错路径）

## 进度事件约定（WebSocket）

### 消息结构（与现有 generate_script 保持一致）
- `type`: `"progress" | "completed" | "error"`
- `scope`: `"extract_subtitle" | "generate_script" | ...`
- `project_id`: string
- `phase`: string（机器可读阶段）
- `message`: string（可展示给用户）
- `progress`: number（0~100，`type=error` 时可省略）
- `timestamp`: string（ISO-like）

### extract_subtitle 的建议阶段与进度映射
- `start`（1%）：开始提取字幕
- `validating_asr`（10%）：验证 ASR 服务可用
- `audio_exists`（20%）：复用已有音频（可选）
- `extract_audio`（30%）：提取音频中
- `audio_ready`（45%）：音频提取完成
- `asr_start`（55%）：ASR 识别中
- `subtitle_ready`（75%）：字幕生成完成
- `subtitle_saved`（85%）：字幕落盘并写入项目
- `subtitle_parsed`（95%）：字幕解析完成，准备返回
- `done`（100%，`type=completed`）：提取字幕成功
- 错误阶段（`type=error`）建议覆盖：
  - `project_not_found / video_missing / asr_unavailable / extract_audio_failed / asr_failed / failed`

## 服务实现拆分建议（便于维护与复用）
- 新增 `backend/services/extract_subtitle_service.py`（或同名模块）
  - 只负责：路径解析、音频提取、ASR、字幕压缩、写文件、更新项目字段、进度广播
- 调整 `backend/services/generate_script_service.py`
  - 只负责：读取字幕、LLM 分析与生成、脚本结构化、保存脚本、进度广播
- 复用/下沉公共函数
  - 将 `compress_srt/parse_srt/resolve_abs_path/to_web_path/uploads_dir` 统一为单一实现（避免 routes 与 services 重复）

## 关键业务规则清单（后端必须兜底）
- “提取字幕”按钮禁用规则不能只依赖前端：后端也要拒绝 `subtitle_source=user` 的提取请求
- “生成解说脚本”必须依赖字幕：后端校验 `subtitle_status` 与文件存在性，避免前端误触导致流程隐式走 ASR
- 编辑字幕后默认不允许被自动覆盖：除非显式 `force=true`（防止用户内容丢失）
- 所有异常都应：
  - 更新项目 `subtitle_status="failed"`（提取字幕流程）
  - 广播 `type=error` WebSocket 事件（便于前端进度条收敛并提示）

## 开发验证清单（后端自测为主）
- 基础链路：
  - 创建项目并上传视频
  - 调 `POST /api/projects/{id}/extract-subtitle`：
    - 能收到 `scope=extract_subtitle` 进度事件
    - 返回 `segments` 非空，且 `project.subtitle_path` 已写入并文件存在
  - 调 `GET /api/projects/{id}/subtitle`：
    - 与提取返回一致，可用于刷新回显
  - 修改并调 `POST /api/projects/{id}/subtitle`：
    - 能写回文件，重新 GET 后内容一致
- 规则校验：
  - 上传字幕后（`subtitle_source=user`）调用提取字幕：
    - 返回 409 且提示正确
  - 无字幕时调用生成脚本：
    - 返回 400 且提示“请先提取字幕或上传字幕”
  - 删除字幕后再次提取字幕：
    - 允许执行且状态字段正确归零/重建
- 回归检查：
  - 现有 `scope=generate_script` 的进度广播仍能被前端订阅并展示
  - 现有字幕上传/删除接口行为不破坏历史项目数据加载

