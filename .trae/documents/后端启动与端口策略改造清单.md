# 后端启动与端口策略改造清单

## 改造目标
- 避免桌面应用误连本机已有的 8000 端口或其它外部服务
- 保证任意并发触发下只启动一个后端进程且端口稳定可用
- 发布模式使用动态高位端口，开发模式保留便捷但安全的策略
- 前端只信任应用自身声明的端口，并进行服务身份校验

## 已完成改造
- 移除应用启动时的后台自动启动线程，避免与前端并行启动导致重复实例  
  参考： [main.rs:setup_app](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/src-tauri/src/main.rs#L617-L649)
- 在 Tauri 命令 `start_backend` 中加入并发启动防护（AtomicBool），确保同一时间只会 spawn 一次  
  参考： [start_backend 并发防护](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/src-tauri/src/main.rs#L396-L418)
- 发布模式也进行端口发现：若系统已有我们自己的后端在监听，则复用该端口而不重复启动  
  参考： [dev/release 端口发现](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/src-tauri/src/main.rs#L256-L279)
- 前端在 Tauri 环境下：未运行则调用 `startBackend()` 启动，并根据返回端口配置 API 与 WS  
  参考： [App.tsx:checkBackendStatus](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/frontend/src/App.tsx#L125-L202)

## 待实施改造
1. 发布模式首选高位端口，避免 8000 端口冲突  
   - 策略：优先选择 18000–18100 段；若被占用再回退扫描  
   - 变更点：调整 `choose_available_port` 首选范围（发布模式）  
   - 参考： [main.rs:choose_available_port](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/src-tauri/src/main.rs#L201-L221)
2. 引入服务身份校验（握手令牌）  
   - Rust 启动后端时生成随机 `SACV_BOOT_TOKEN` 并通过环境变量传给后端  
   - Python 后端在 `/api/server/info` 返回 `identifier`、`version`、`boot_token`  
   - 前端在拿到 Tauri 返回的端口后，调用 `/api/server/info` 校验令牌匹配，确保不会误连外部服务  
   - 变更点：  
     - [main.rs:start_backend 注入令牌](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/src-tauri/src/main.rs#L396-L418)（新增）  
     - [backend/main.py:get_server_info 返回令牌](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/backend/main.py#L263-L276)（扩展返回）  
     - [frontend/src/services/clients.ts 启动后端与握手校验](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/frontend/src/services/clients.ts#L456-L487)（扩展返回/校验）
3. 发布模式禁用端口自发现，只信任 Tauri 返回的端口  
   - 开发模式可保留自动发现以提升调试效率，但仍建议做身份校验  
   - 变更点： [App.tsx:checkBackendStatus 流程](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/frontend/src/App.tsx#L125-L202)
4. 统一启动失败提示与重试策略  
   - Rust 侧就绪等待与日志解析已实现；完善前端 UI 提示（例如 60s 超时引导查看日志文件）  
   - 参考： [main.rs:等待就绪与日志解析](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/src-tauri/src/main.rs#L444-L479)
5. 清理构建警告与未使用导入（维持构建输出干净）  
   - 变更点：移除未使用的 `Read/Write/ZipArchive` 导入与冗余变量  
   - 参考： 构建输出中的警告（`cargo check`）

## 实施步骤（建议顺序）
- 步骤 1：调整端口策略（发布模式优先 18000+）  
  修改 `choose_available_port`；根据 `cfg!(debug_assertions)` 或 `TAURI_DEV` 环境区分 dev/release 策略
- 步骤 2：实现令牌校验链路  
  在 Rust 生成令牌并注入环境 → Python 返回令牌与标识 → 前端启动后握手校验
- 步骤 3：发布模式禁用端口自发现  
  在 `App.tsx` 按模式分支：release 只使用 Tauri 返回；dev 可保留 discover（并做身份校验）
- 步骤 4：完善失败提示与重试  
  前端展示“启动中/等待就绪/查看日志”的状态与引导；失败后可提供一次重试入口
- 步骤 5：清理与检查  
  移除未使用导入、运行 `cnpm run type-check`、`cnpm run lint`、`cargo check`

## 验收标准
- 本机已有 8000 服务时，应用仍能启动并连接到自有后端端口（高位端口）  
- 前端只连接到具备正确 `identifier` 与 `boot_token` 的后端；不会误连外部服务  
- 并发触发启动仅有一个后端进程；PID 与端口一致  
- Windows 安装包与便携版行为一致；日志与错误提示可帮助定位问题

## 参考文件
- Rust/Tauri： [main.rs](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/src-tauri/src/main.rs)
- Tauri 配置： [tauri.conf.json](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/src-tauri/tauri.conf.json)
- Python 后端入口： [backend/main.py](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/backend/main.py)
- 前端入口与客户端： [App.tsx](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/frontend/src/App.tsx)、[clients.ts](file:///Users/jiangchao/Documents/江汐瑶/学习/测试/superAIAutoCutVideo/frontend/src/services/clients.ts)

