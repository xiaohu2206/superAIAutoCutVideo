# TrimTimeline 时间轴缩放与游标拖拽交互设计（参考剪映）

## 1. 背景与问题

当前 [TrimTimeline.tsx](file:///e:/learn/superAutoCutVideoApp/frontend/src/components/projectEdit/TrimTimeline.tsx#L49-L176) 的时间映射是“整段视频时长 → 单条固定宽度条形区域”，即：
- `ms = (x / barWidth) * durationMs`（见 [msFromClientX](file:///e:/learn/superAutoCutVideoApp/frontend/src/components/projectEdit/TrimTimeline.tsx#L49-L54)）

在长视频（例如 3 小时 = 10,800,000ms）场景下，单位像素对应的时间跨度非常大，导致：
- 很难通过点击/拖动精确定位到某个较小时间点（例如 200ms~2s 级别）
- “拖拽空白处创建区间”与“希望拖拽游标定位”的意图冲突（按下即进入 create/resize 状态）
- 缺少时间刻度、缩放、平移等编辑器常见能力，用户无法通过“先粗定位→再精定位”的方式完成精修

本设计将时间轴交互升级为“可缩放、可平移、带刻度尺、支持精细拖拽”的两层结构，交互参考剪映/CapCut：先用概览快速跳转，再在放大视窗内精确拖拽与编辑。

## 2. 目标与非目标

### 2.1 目标
- 长视频下仍能在 1s 以内成本精确定位（目标体验：常见场景可稳定定位到 100ms~500ms 精度）
- 提供时间轴缩放（按钮/滚轮/触控板/手势）与横向平移能力
- 增加时间刻度尺（自适应刻度密度 + 可读的时间码）
- 支持“精细拖拽模式”（拖拽减速/放大镜/吸附），降低误操作
- 不破坏现有“区间 ranges + 把手 resize”编辑范式，可渐进升级

### 2.2 非目标（本轮不做）
- 波形/缩略图帧轨道生成（可作为后续增强）
- 多轨道（音频/字幕/特效）编辑器级能力
- 关键帧/速度曲线等高级编辑能力

## 3. 方案总览（结构与心智模型）

整体采用“两层时间轴”：
- **概览层（Overview）**：展示全片（0~duration），可通过拖拽“视窗框”快速跳转到任意位置
- **编辑层（Main Timeline）**：只展示一个“可缩放视窗”（viewport），用户在此进行游标定位、区间创建与微调

核心心智模型：
- 用户先在概览层粗定位（分钟/小时级）
- 再在编辑层放大，精确定位到秒/帧级（按需多次放大）

## 4. UI 组成（建议布局）

### 4.1 工具条（Timeline Toolbar）
放在编辑层上方或右侧，包含：
- 缩放按钮：`-` / `+`
- 缩放级别显示：如 `10 min / 屏` 或 `200 ms/px`
- 适配按钮：`Fit`（让 viewport 显示全片）
- 吸附开关：磁铁图标（默认开）
- 精细模式开关：`精`（默认关，或按住快捷键进入）

### 4.2 时间刻度尺（Ruler）
紧贴编辑层顶部：
- 主刻度（带文字）：显示 `HH:MM:SS`，必要时显示 `HH:MM:SS.mmm`
- 次刻度（无文字）：用于视觉辅助与吸附候选
- 鼠标悬停/拖拽时显示时间 tooltip（跟随游标/指针）

### 4.3 编辑轨道（Track Area）
高度建议从当前 `h-10` 提升为可配置（默认 72px~96px）：
- playhead（红线）可拖拽（主要定位手段）
- ranges 仍以半透明色块展示，并保留左右把手
- 在拖拽时显示：
  - 吸附线（snap line）
  - 当前时间 tooltip（时间码）

### 4.4 概览层（Overview）
位于编辑轨道上方或下方，高度 24px~36px：
- 背景为全片条形（可继续使用灰色）
- 覆盖一个“视窗框”（viewport window），可拖拽移动、拖拽左右边缘改变缩放（可选）
- 点击任意位置：将视窗中心跳到该处（不改变缩放）

## 5. 交互细则（参考剪映的关键点）

### 5.1 游标定位（Playhead）
目标：把“拖拽定位”变成最高频、最低成本动作。
- **拖拽 playhead**：按下红线附近（带一定容错区域）进入拖拽，实时 `onSeek(ms)`
- **点击刻度尺/轨道空白**：移动 playhead 到点击处（不创建区间）
- **拖拽轨道空白**：默认行为改为“拖拽平移视窗（pan）”或“拖拽游标（scrub）”，二选一：
  - 建议 A（更像剪映）：拖拽空白 = scrub（移动 playhead）
  - 建议 B（更像编辑器）：拖拽空白 = pan（移动 viewport），点击空白 = seek

### 5.2 精细拖拽模式（Fine Scrub）
解决“放大后仍很难落到某个小点”的最后 1mm 问题：
- **按住 Alt/Option**：拖拽速度减慢（例如 0.1x），提高微调精度
- **按住 Shift**：吸附更强（更容易贴合刻度/边界）
- 可选增强：**放大镜（Magnifier）**
  - 拖拽时在 playhead 上方弹出一个小窗，显示以 playhead 为中心的 ±2s/±5s 局部刻度
  - 放大镜内的拖动与主时间轴联动，提供更细颗粒刻度

### 5.3 缩放（Zoom）
满足两类用户：按钮用户与触控板用户。
- 按钮：`+/-` 每次缩放一档（例如 *1.25 或 *1.5）
- 滚轮/触控板：
  - `Ctrl + 滚轮`：以鼠标指针位置为锚点缩放（CapCut 常见做法）
  - 触控板 pinch：以手势中心为锚点缩放
- 缩放锚点策略：
  - 默认锚点 = 鼠标指针（如果在时间轴区域内）
  - 否则锚点 = playhead
- 缩放后保持锚点对应的时间不变（避免“放大后位置跳走”）

### 5.4 平移（Pan / Scroll）
编辑层只展示 viewport 范围，需支持平移浏览：
- 鼠标滚轮：横向滚动（或 `Shift + 滚轮` 横向）
- 触控板双指：横向平移
- 拖拽空白（若选择“拖拽空白 = pan”）：按下拖拽直接移动 viewport

### 5.5 区间创建与编辑（Ranges）
为了不与“拖拽定位”冲突，区间创建需要更明确的入口。

推荐的“无冲突”方案（优先）：
- **创建区间**：
  - 方式 1：工具条按钮“添加区间”（以 playhead 为起点，默认长度 5s，可立即拖拽右边界）
  - 方式 2：按住快捷键（如 `B` 或 `R`）+ 拖拽轨道生成区间（类似“临时进入画笔/范围工具”）
- **调整区间**：
  - 仍通过左右把手拖拽 start/end
  - 把手命中范围建议扩大：视觉宽度可保持 8px，但命中区域（hit slop）扩到 12~16px（透明区域即可）

兼容旧习惯的折中方案（备选）：
- 继续允许“拖拽空白创建区间”，但仅在满足以下任一条件时触发：
  - 按住 Shift 再拖拽
  - 或先点击“创建区间”按钮进入一次性“创建模式”（创建完成自动退出）

### 5.6 吸附（Snap）
吸附对象：
- 刻度尺主/次刻度（根据当前缩放级别）
- 当前 playhead
- 各 ranges 的 start/end 边界
- 可选：整秒、整帧（若未来引入 fps）

吸附策略：
- 设定一个基于像素的吸附阈值，例如 `snapPx = 6px`
- 将 `snapPx` 转为时间阈值：`snapMs = snapPx * msPerPx`
- 在拖拽时若候选点与目标点差值 < `snapMs`，则吸附并显示吸附线

## 6. 数据模型与计算（实现所需概念）

时间轴从“全片百分比”升级为“viewport + 缩放”模型：
- `durationMs`: 全片总时长
- `viewportStartMs`: 当前视窗起点（0~duration）
- `viewportMs`: 当前视窗覆盖的时长（越小表示越放大）
- `msPerPx = viewportMs / viewportWidthPx`
- `playheadMs`: 当前游标时间（来自 currentMs）

坐标映射：
- 屏幕 x → 时间：`ms = viewportStartMs + x * msPerPx`
- 时间 → 屏幕 x：`x = (ms - viewportStartMs) / msPerPx`

缩放时保持锚点时间不变（关键体验点）：
- 已知锚点屏幕位置 `anchorX` 与锚点时间 `anchorMs`
- 缩放后 `msPerPx'` 改变，则更新 `viewportStartMs' = anchorMs - anchorX * msPerPx'`
- 再 clamp 到 `[0, durationMs - viewportMs']`

## 7. 刻度尺生成规则（自适应刻度密度）

目标：刻度标签不拥挤且可读，主刻度间隔保持在 80~140px 左右。

输入：
- `msPerPx`
- `viewportWidthPx`

步骤（概念性）：
1. 计算期望主刻度间隔（ms）：`targetMajorMs = msPerPx * 100px`
2. 将 `targetMajorMs` 归一到“好看间隔”（nice step）：
   - 候选序列（秒级）：`[0.1, 0.2, 0.5, 1, 2, 5, 10, 15, 30, 60, 120, 300, 600, 900, 1800, 3600]` 秒
   - 转成 ms 后选取最接近但不小于 target 的值
3. 次刻度：`minorStep = majorStep / 5`（或 /4，按视觉效果）
4. 仅渲染 viewport 内的刻度（避免 DOM 过多）

标签格式：
- `>= 1h`：`HH:MM:SS`
- `< 1h`：`MM:SS`
- 当 `majorStep < 1s`：显示到 `SS.mmm`

## 8. 高度与可视性建议

默认高度建议：
- Overview：`28px`
- Ruler：`24px`
- Track：`80px`（可在工具条提供“高度 +/−”或拖拽分割条调整）

原因：
- 较高的轨道能容纳 tooltip、吸附线、范围块与把手，减少遮挡
- 在长视频场景中，视觉层级越清晰，越容易定位与微调

## 9. 可用性与容错（关键细节）

- 命中区域容错：
  - playhead 红线很细，但命中区域应更宽（例如 ±6~10px）
  - ranges 把手视觉可窄，但命中应宽
- 拖拽阈值：
  - pointer down 后移动 < 3px 视为点击，避免误触拖拽
- 性能：
  - 刻度与 ranges 渲染只基于 viewport 内元素
  - 拖拽时 `onSeek` 可节流到 `requestAnimationFrame` 级别，避免 UI 卡顿（尤其是视频 seek）

## 10. 验收标准（MVP）

- 3 小时视频下：
  - 可通过缩放把视窗放大到“每屏 10 秒以内”
  - 拖拽 playhead 时，时间 tooltip 实时更新且可读
  - 可通过 Overview 快速跳转到任意 30 分钟段落
- 时间刻度：
  - 缩放变化时刻度密度自适应，标签不重叠
  - 吸附开启时，游标/把手可吸附到刻度与边界
- 编辑冲突消除：
  - 用户在不创建区间的情况下可以顺畅拖拽定位
  - 创建区间有明确入口（按钮或快捷键），不会与定位动作互相干扰

## 11. 迭代建议

### Phase 1（最小可用）
- 引入 viewport 模型（缩放 + 平移）
- 增加 ruler 刻度与 tooltip
- playhead 可拖拽 + Alt 精细拖拽
- Overview + viewport window（仅拖拽移动）

### Phase 2（增强体验）
- Overview 视窗边缘可拖拽缩放
- 放大镜 magnifier
- 更丰富的 snap（对齐到 ranges 边界、整秒、整帧）
- 轨道高度可调整并持久化（localStorage）

