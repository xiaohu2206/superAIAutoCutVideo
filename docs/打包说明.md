**打包与发布说明（Tauri + PyInstaller｜Windows / macOS / Linux）**

- 本说明覆盖前端构建、后端打包、Tauri 封装与最终产物位置，并给出一键脚本与手动步骤两种方式。
- 当前实现：前端使用 Vite 构建，后端使用 PyInstaller `--onefile` 打包为独立可执行文件，桌面应用由 Tauri 进行封装，并将后端随应用一起分发。

**环境要求**
- 通用：
  - `Node.js`（建议 LTS）与 `npm`
  - `Python 3.9+` 与 `pip`（推荐 3.11/3.12 更容易命中预编译轮子）
  - `Rust` 稳定版 与 `cargo`
  - `cargo-tauri`（未安装：`cargo install tauri-cli --locked` 或 `npm i -g @tauri-apps/cli`）
- Windows 额外：
  - `Visual Studio Build Tools`（含 C++ 构建工具；Tauri 需 MSVC 工具链）
  - WebView2 Runtime（若白屏建议安装 Evergreen 版）
- macOS 额外：
  - Xcode 或 Command Line Tools（用于构建）
  - 如需签名/公证需正确配置开发者证书
- Linux 额外：
  - 基础构建工具与系统依赖（用于打包 AppImage/Deb）

**一键打包（推荐）**
- Windows（PowerShell，项目根目录执行）：
  - 标准打包（运行时精简依赖 `requirements.runtime.txt`）：
    - `powershell -ExecutionPolicy Bypass -File scripts\build.ps1`
  - 完整依赖打包（使用 `requirements.txt`）：
    - `powershell -ExecutionPolicy Bypass -File scripts\build.ps1 -FullBackend`
- macOS / Linux（Bash，项目根目录执行）：
  - `bash scripts/build.sh`

**脚本流程（实际实现）**
- 清理旧产物：`backend/dist`、`backend/build`、`src-tauri/target/release`、`src-tauri/resources/superAutoCutVideoBackend[.exe]`
- 前端：进入 `frontend` 执行 `npm ci`（首次）与 `npm run build`
- 后端：进入 `backend`，安装依赖并执行
  - `pyinstaller --onefile --name superAutoCutVideoBackend --distpath dist main.py`
  - Windows PS 脚本包含兼容修复：若检测到 `backports` 命名空间问题，会卸载并确保 `backports.tarfile` 存在
- 复制后端：拷贝 `backend/dist/superAutoCutVideoBackend[.exe]` → `src-tauri/resources/`
- 桌面应用：进入 `src-tauri` 执行打包
  - Windows：优先尝试 `cargo tauri build --bundles nsis,msi`，失败则回退 `nsis`
  - macOS：生成 `.app` 与 `.dmg`
  - Linux：生成 `.AppImage` 与 `.deb`（如配置）
- Windows 脚本额外输出：可便携版 ZIP（包含 `super-auto-cut-video.exe` 与资源目录），在控制台以 “Portable ZIP” 路径提示

**产物位置**
- Windows：
  - 安装包（推荐分发）：`src-tauri\target\release\bundle\nsis\*.exe`、`src-tauri\target\release\bundle\msi\*.msi`
  - 便携版 EXE：`src-tauri\target\release\super-auto-cut-video.exe`（脚本会额外生成 ZIP）
  - 后端（随应用打包）：`src-tauri\target\release\resources\superAutoCutVideoBackend.exe`
  - 前端静态资源：`frontend\dist\`
- macOS：
  - 应用包：`src-tauri/target/release/bundle/macos/*.app`
  - 安装包：`src-tauri/target/release/bundle/dmg/*.dmg`
  - 后端（随应用打包）：包含于 `*.app` 的 `Resources/superAutoCutVideoBackend`
- Linux：
  - 应用包：`src-tauri/target/release/bundle/appimage/*.AppImage`
  - 安装包：`src-tauri/target/release/bundle/deb/*.deb`
  - 后端（随应用打包）：置于应用资源目录（随平台方式）

**运行与验证**
- 直接运行桌面应用（示例：Windows 双击 `super-auto-cut-video.exe` 或安装后启动）。
- 应用启动后会自动拉起后端：
  - 优先路径：`app_handle.path().resource_dir()`，即打包资源目录（Windows 为 `target\release\resources`）
  - 已设置后端进程工作目录为资源目录，便于读取相对资源文件
  - 启动就绪等待时间上限约 20 秒（涵盖 `onefile` 首次解压等冷启动场景）
  - 若默认端口占用，会自动寻找可用端口并与前端联动，无需手动调整
- 验证 API：前端会调用 `/api/hello` 做就绪探测；也可手动访问：`http://127.0.0.1:<端口>/api/hello`

**端口与自动配置**
- 后端启动环境变量：由 Tauri 注入 `HOST=127.0.0.1` 与 `PORT`（默认尝试 8000，自动回退到空闲端口）
- 前端在 Tauri 环境下：通过命令 `get_backend_status` 获取端口并动态配置 HTTP 与 WS 端点
- 浏览器开发环境下：前端会自动尝试发现后端端口（遍历少量候选），并调用 `/api/server/info` 确认最终端口

**Tauri 打包配置要点**
- `src-tauri/tauri.conf.json`：
  - `productName`: `AI智能视频剪辑`
  - `identifier`: `com.superautocutvideo.app`
  - `bundle.resources`: `["resources/superAutoCutVideoBackend.exe"]`（Windows）/ `resources/superAutoCutVideoBackend`（macOS/Linux）
  - 如需生成安装包（NSIS/MSI/DMG/AppImage/Deb），将对应类型加入 `bundle` 的 `targets` 或在构建命令中选择 `--bundles`

**开发环境（可选）**
- Windows：`scripts\dev.bat`
- macOS/Linux：`scripts/dev.sh`
- 仅 Tauri（macOS/Linux）：`scripts/dev_tauri.sh`（会优先使用 `backend/.venv` 的 Python）
- 预计拉起：后端（默认 8000）、前端 Dev（默认 1420）、Tauri 桌面应用

**常见问题与排查**
- PowerShell 执行策略限制：使用 `-ExecutionPolicy Bypass`
- 依赖下载缓慢/失败：为 npm/pip 配置国内镜像或代理；必要时重试脚本
- 前端构建失败：确认 `frontend` 能正常 `npm ci && npm run build`；可清理 `node_modules` 后重试（BAT 脚本已做 `npm install` 回退）
- 后端打包失败：
  - 优先使用 `requirements.runtime.txt`；仍失败可加 `-FullBackend` 使用完整依赖
  - Windows 脚本会处理 `backports` 命名空间冲突并强制安装 `backports.tarfile`
  - 手动执行以查看详细日志：`cd backend && pyinstaller --onefile --name superAutoCutVideoBackend --distpath dist main.py`
- 运行后无法连接后端：
  - 检查是否有残留进程：`Get-Process superAutoCutVideoBackend -ErrorAction SilentlyContinue | Stop-Process -Force`
  - 查看临时日志：系统临时目录 `super_auto_cut_backend.log`
  - 确认 `src-tauri/target/release/resources/superAutoCutVideoBackend[.exe]` 存在且可手动运行
  - 某些杀毒/防护软件可能误报，需加入信任列表
- 缺少 WebView2（Windows）：若启动白屏，安装 Microsoft WebView2 Runtime（Evergreen）

**手动打包（进阶/排障）**
- 前端：
  - `cd frontend && npm ci && npm run build && cd ..`
- 后端（PyInstaller）：
  - `cd backend`
  - `pip install -r requirements.runtime.txt`（或 `requirements.txt`）
  - `pyinstaller --onefile --name superAutoCutVideoBackend --distpath dist main.py`
  - `cd ..`
- 复制后端到资源目录：
  - Windows：`mkdir src-tauri\resources && copy backend\dist\superAutoCutVideoBackend.exe src-tauri\resources\`
  - macOS/Linux：`mkdir -p src-tauri/resources && cp backend/dist/superAutoCutVideoBackend src-tauri/resources/`
- Tauri 打包：
  - `cd src-tauri && cargo tauri build --release && cd ..`

**清理与重建**
- 快速清理：删除如下目录/文件后重新执行脚本：
  - `backend/dist`、`backend/build`
  - `src-tauri/target`、`src-tauri/resources/superAutoCutVideoBackend[.exe]`
- Windows 一键脚本已内置清理步骤（默认执行）

**目录参考（关键路径）**
- Windows：
  - `src-tauri\target\release\super-auto-cut-video.exe`
  - `src-tauri\target\release\resources\superAutoCutVideoBackend.exe`
  - `src-tauri\target\release\bundle\nsis\*`、`src-tauri\target\release\bundle\msi\*`
  - `frontend\dist\`
- macOS / Linux：
  - `src-tauri/target/release/bundle/macos/*.app`、`src-tauri/target/release/bundle/dmg/*.dmg`
  - `src-tauri/target/release/bundle/appimage/*.AppImage`、`src-tauri/target/release/bundle/deb/*.deb`

**备注**
- 若需要进一步集成 CI/CD、自动更新或官方 sidecar 机制，可在后续迭代中加入。
- 本项目代码中已实现后端自动启动、端口自动回退与就绪检测（20 秒等待），文档中的说明与实现保持一致。