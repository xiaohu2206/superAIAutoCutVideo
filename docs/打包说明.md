# 打包说明（Windows）

本项目为「SuperAIAutoCutVideo」桌面应用，采用 Tauri + React 前端 + Python FastAPI 后端。打包流程分为：前端构建、后端打包为单文件 exe、复制到 Tauri 资源目录、构建桌面应用与安装包。

参考文件：
- 配置文件：[tauri.conf.json](file:///c:/Users/Administrator/Documents/superAIAutoCutVideo/src-tauri/tauri.conf.json)
- 一键脚本（PowerShell）：[build.ps1](file:///c:/Users/Administrator/Documents/superAIAutoCutVideo/scripts/build.ps1)
- 一键脚本（批处理）：[build.bat](file:///c:/Users/Administrator/Documents/superAIAutoCutVideo/scripts/build.bat)
- 运行说明：[README.md](file:///c:/Users/Administrator/Documents/superAIAutoCutVideo/README.md)、[USAGE.md](file:///c:/Users/Administrator/Documents/superAIAutoCutVideo/USAGE.md)

## 环境要求
- Windows 10/11（64 位）
- Node.js ≥ 18（包含 npm 或 cnpm）
- Python ≥ 3.11（包含 pip）
- Rust（含 Cargo）与 Tauri CLI（构建桌面应用）
- FFmpeg（可选，放入 PATH 供后端使用）
- NSIS（用于生成安装包，可选）

建议在 PowerShell 中运行，并临时放宽执行策略：

```powershell
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process
```

## 一键打包（推荐）
两种等效脚本，任选其一：

1) PowerShell 脚本（推荐；功能更完整）：
```powershell
cd c:\Users\Administrator\Documents\superAIAutoCutVideo
.\scripts\build.ps1
```

torch-2.5.1+cpu-cp311-cp311-win_amd64.whl
torch-2.5.1+cu121-cp311-cp311-win_amd64.whl
torchvision-0.20.1+cpu-cp311-cp311-win_amd64.whl
torchvision-0.20.1+cu121-cp311-cp311-win_amd64.whl



2) 批处理脚本：
```powershell
cd c:\Users\Administrator\Documents\superAIAutoCutVideo
.\scripts\build.bat
```

脚本会自动：
- 清理旧产物（backend/dist、src-tauri/target 等）
- 前端：安装依赖（优先 cnpm，回退 npm）并构建到 frontend/dist
- 后端：安装依赖，使用 PyInstaller 生成 backend/dist/superAutoCutVideoBackend.exe
- 复制后端 exe 至 src-tauri/resources/
- 构建 Tauri 应用与安装包（nsis/msi 提示与回退逻辑由脚本处理）
- 额外生成便携版 ZIP（包含 super-auto-cut-video.exe 与 resources 目录）

## 手动打包（排障/定制）
如果需要逐步执行以定位问题，可按以下顺序进行：

1) 前端构建
```powershell
cd c:\Users\Administrator\Documents\superAIAutoCutVideo\frontend
cnpm install; if ($LASTEXITCODE -ne 0) { npm ci }
cnpm run build; if ($LASTEXITCODE -ne 0) { npm run build }
```
生成目录：frontend/dist

2) 后端打包为单文件 exe
```powershell
cd c:\Users\Administrator\Documents\superAIAutoCutVideo\backend
pip install -r requirements.runtime.txt  # 或 requirements.txt
pyinstaller --onefile --name superAutoCutVideoBackend --distpath dist main.py
```
生成目录：backend/dist/superAutoCutVideoBackend.exe

3) 复制后端到 Tauri 资源目录
```powershell
cd c:\Users\Administrator\Documents\superAIAutoCutVideo
New-Item -ItemType Directory -Force -Path "src-tauri\resources" | Out-Null
Copy-Item "backend\dist\superAutoCutVideoBackend.exe" "src-tauri\resources\" -Force
```

4) 构建 Tauri 桌面应用
```powershell
cd c:\Users\Administrator\Documents\superAIAutoCutVideo\src-tauri
cargo tauri build
```

## Qwen3‑TTS 集成（打包与模型）
- 依赖安装策略：构建脚本会在安装后端依赖时过滤 `qwen-tts`，并在后续以 `pip install qwen-tts --no-deps` 单独安装，避免依赖解析联动升级核心库；同时在后端依赖中锁定 `numpy<=2.3.5` 以兼容 `numba`。
- PyInstaller 配置：后端打包规范已在 [backend.spec](file:///c:/Users/Administrator/Documents/superAIAutoCutVideo/backend/backend.spec) 中将 `qwen_tts` 加入 `hiddenimports`，并在存在时收集 `.trae/cache/Qwen3-TTS` 目录到可执行文件内，便于离线环境复用缓存。
- 手动打包时的建议：
  - 先安装运行时依赖（不含 `qwen-tts`），再执行 `pip install qwen-tts --no-deps`。
  - 可选地预创建缓存目录以参与打包：

```powershell
cd c:\Users\Administrator\Documents\superAIAutoCutVideo
New-Item -ItemType Directory -Force -Path ".trae\cache\Qwen3-TTS" | Out-Null
```

- 模型文件不随 exe 打包：运行前需将模型放置到本地目录，默认路径为 `uploads/models/Qwen/<模型目录>`；也可通过环境变量覆盖：
  - `QWEN_TTS_MODELS_DIR`：指定 Qwen3‑TTS 模型根目录
  - `SACV_UPLOADS_DIR`：覆盖应用上传/数据根目录（影响默认 `uploads/models/Qwen` 位置）
- 应用内模型管理：在设置页进入“语音 → Qwen3‑TTS → 模型管理”，支持列出/下载/校验模型目录。服务端接口同样提供下载与校验能力。
- 运行期常见错误与处理：
  - `qwen_tts_not_installed` / `qwen_tts_import_failed`：按 README 的“Qwen3‑TTS 安装与验证”安装 `qwen-tts`，并保证 `numpy<=2.3.5`。
  - `model_invalid:<key>:...|path=...`：模型文件缺失或目录不完整。请先下载或放置完整模型，并按需设置 `QWEN_TTS_MODELS_DIR/SACV_UPLOADS_DIR`。
  - 缺少 FFmpeg：后端启动会自动尝试配置 FFmpeg；如仍缺失，可手动放入 `src-tauri/resources`。

### Qwen3‑TTS GPU 加速与注意力实现（可选）
- Windows 环境默认使用 `sdpa` 注意力实现以确保兼容性；FlashAttention 2 在 Windows 上通常需要本地编译，成功率较低。
- Linux 环境如需启用 FlashAttention 2，请确保 PyTorch CUDA 版本与系统 CUDA 工具链一致（例如 torch 2.5.1+cu121 对应 CUDA 12.1），并安装 `flash-attn`。
- 运行时策略（已内置）：
  - GPU 可用时优先尝试 `flash_attention_2 + bfloat16`；失败则自动回退到 `sdpa + float16`，且保持在 GPU，不回退 CPU。
  - CPU 模式强制 `float32`，避免 CPU Half/BFloat16 算子不支持。
- 验证 GPU：
  - `python -c "import torch; print(torch.cuda.is_available(), torch.cuda.device_count())"`
  - `python -c "import torch; p=torch.cuda.get_device_properties(0); print(p.name, p.total_memory)"`（需至少 1 块 GPU）
## 产物位置
- 桌面应用（便携版可执行文件）：
  - `src-tauri\target\release\super-auto-cut-video.exe`
- 资源目录（随应用一起分发）：
  - `src-tauri\target\release\resources\superAutoCutVideoBackend.exe`
- 安装包（NSIS）：
  - `src-tauri\target\release\bundle\nsis\*.exe`
- 前端静态资源：
  - `frontend\dist\`

## 运行与验证
- 直接运行桌面应用：双击 `src-tauri\target\release\super-auto-cut-video.exe` 或安装后启动。
- 应用启动会自动拉起后端，默认在 `127.0.0.1` 上选择可用端口（默认尝试 8000）。
- 前端会自动发现后端端口，无需手动设置。
- 验证 API：可访问 `http://127.0.0.1:<端口>/api/hello`，或在应用内查看状态面板。

## 常见问题与排查
- 时间戳显示“昨天”：Windows 文件属性中的“修改日期”通常在复制时保留。若希望显示为“今天”，请重新用 PyInstaller 生成后端 exe，再复制并打包。
- 构建报错 “另一个程序正在使用此文件，进程无法访问 (os error 32)”：
  - 关闭正在运行的 `superAutoCutVideoBackend.exe` 或 `super-auto-cut-video.exe`，再执行构建。
  - PowerShell 尝试结束：
    ```powershell
    Get-Process superAutoCutVideoBackend -ErrorAction SilentlyContinue | Stop-Process -Force
    Get-Process super-auto-cut-video -ErrorAction SilentlyContinue | Stop-Process -Force
    ```
  - 若仍提示“拒绝访问”，请以管理员身份运行 PowerShell，或重启系统后重试。
- 前端构建失败：清理 `node_modules`，确认使用 Node.js ≥ 18，并重试 `npm ci && npm run build`。
- 后端依赖问题（如 backports 命名空间冲突）：PowerShell 脚本已包含自动修复（卸载 `backports` 并安装 `backports.tarfile`）。
- 缺少 WebView2（白屏）：安装 Microsoft WebView2 Runtime（Evergreen）。
- 安装包生成失败：确保 NSIS 已安装；脚本会在失败时回退仅构建 NSIS 安装包。

## 清理与重建
在根目录执行以下清理后重试：
```powershell
Remove-Item -Recurse -Force backend\dist, backend\build, src-tauri\target, src-tauri\resources\superAutoCutVideoBackend.exe
```
也可直接运行一键脚本，脚本会自动清理并重建。

## 配置要点
- Tauri 配置文件：[tauri.conf.json](file:///c:/Users/Administrator/Documents/superAIAutoCutVideo/src-tauri/tauri.conf.json)
  - `bundle.resources`: `["resources/*"]`（会将 `src-tauri/resources` 下所有文件打包到应用资源目录）
  - `build.frontendDist`: 指向 `../frontend/dist`
  - `bundle.targets`: 当前启用 `nsis`（可安装包）

## CI 打包（可选）
项目可在 GitHub Actions 上进行自动构建（仅 Windows）。工作流会安装 Node/Python/Rust/Tauri/FFmpeg/NSIS，构建前后端并产出安装包与便携版。根据你的仓库配置，参见 `.github/workflows/` 下的工作流文件。

— 完 —
