name: Build Windows EXE

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install Tauri CLI (v2)
      run: |
        cargo install tauri-cli --version ">=2.0.0,<3.0.0" --locked
        cargo tauri --version

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: src-tauri/target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

    - name: Install FFmpeg
      run: choco install ffmpeg -y --no-progress

    - name: Install NSIS
      run: choco install nsis -y --no-progress

    - name: Install frontend dependencies
      working-directory: frontend
      run: |
        npm ci
        if ($LASTEXITCODE -ne 0) {
          Write-Host "npm ci failed, falling back to npm install"
          npm install
        }

    - name: Build frontend
      working-directory: frontend
      run: npm run build

    - name: Install Python dependencies
      working-directory: backend
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build Python backend
      working-directory: backend
      run: |
        pyinstaller --onefile `
          --name superAutoCutVideoBackend `
          --hidden-import=uvicorn.logging `
          --hidden-import=uvicorn.loops `
          --hidden-import=uvicorn.loops.auto `
          --hidden-import=uvicorn.protocols `
          --hidden-import=uvicorn.protocols.http `
          --hidden-import=uvicorn.protocols.http.auto `
          --hidden-import=uvicorn.protocols.websockets `
          --hidden-import=uvicorn.protocols.websockets.auto `
          --hidden-import=uvicorn.lifespan `
          --hidden-import=uvicorn.lifespan.on `
          --collect-all=cv2 `
          --collect-all=numpy `
          --noconfirm `
          main.py

    - name: Create resources directory
      run: |
        New-Item -ItemType Directory -Path "src-tauri\resources" -Force

    - name: Copy backend to resources
      run: |
        Copy-Item "backend\dist\superAutoCutVideoBackend.exe" "src-tauri\resources\" -Force

    - name: Verify setup
      run: |
        Write-Host "=== Verification ==="
        Write-Host "Frontend build:"
        Test-Path "frontend\dist" | Out-Host
        Write-Host "`nBackend in resources:"
        Test-Path "src-tauri\resources\superAutoCutVideoBackend.exe" | Out-Host
        Write-Host "`nFFmpeg:"
        ffmpeg -version | Select-Object -First 1

    - name: Verify Tauri config file
      run: |
        Write-Host "=== Verify tauri.conf.json ==="
        if (Test-Path "src-tauri\tauri.conf.json") {
          $item = Get-Item "src-tauri\tauri.conf.json"
          Write-Host "Path: $($item.FullName)"
          Write-Host "Size: $($item.Length) bytes"
          if ($item.Length -eq 0) { throw "tauri.conf.json is empty" }
          Get-Content "src-tauri\tauri.conf.json" -Head 20 | ForEach-Object { Write-Host $_ }
        } else {
          throw "src-tauri\\tauri.conf.json not found"
        }

    - name: Show Tauri config header bytes
      run: |
        Write-Host "=== Hex dump (first 16 bytes) ==="
        Format-Hex "src-tauri\tauri.conf.json" | Select-Object -First 3

    - name: Patch Tauri config for CI
      run: |
        Write-Host "=== Patching tauri.conf.json for GitHub Actions ==="
        $path = "src-tauri\tauri.conf.json"
        $content = Get-Content $path -Raw
        $content = $content -replace 'cnpm', 'npm'
        try {
          $json = $content | ConvertFrom-Json
          if ($json.bundle -and $json.bundle.windows -and $json.bundle.windows.nsis) {
            $json.bundle.windows.nsis.languages = @('English')
            $json.bundle.windows.nsis.PSObject.Properties.Remove('customLanguageFiles') | Out-Null
          }
          $content = $json | ConvertTo-Json -Depth 10
        } catch {
          Write-Host "JSON patch failed, keeping text replace only"
        }
        Set-Content $path $content
        Write-Host "Patched tauri.conf.json: cnpm->npm, NSIS languages -> English"

    - name: Provide NSIS en-US language file
      run: |
        Write-Host "=== Preparing NSIS en-US language file for Tauri cache ==="
        $destDirLocal = Join-Path -Path $env:LOCALAPPDATA -ChildPath "tauri\NSIS\Contrib\Language files"
        if (!(Test-Path $destDirLocal)) {
          New-Item -ItemType Directory -Path $destDirLocal -Force | Out-Null
        }
        $destDirRepo = Join-Path -Path "src-tauri" -ChildPath "nsis"
        if (!(Test-Path $destDirRepo)) {
          New-Item -ItemType Directory -Path $destDirRepo -Force | Out-Null
        }
        $pf86 = [Environment]::GetEnvironmentVariable('ProgramFiles(x86)')
        $pf = [Environment]::GetEnvironmentVariable('ProgramFiles')
        $candidates = @()
        if ($pf86) { $candidates += (Join-Path -Path $pf86 -ChildPath 'NSIS\Contrib\Language files\English.nlf') }
        if ($pf) { $candidates += (Join-Path -Path $pf -ChildPath 'NSIS\Contrib\Language files\English.nlf') }
        $englishNlf = $candidates | Where-Object { $_ -and (Test-Path $_) } | Select-Object -First 1
        if (-not $englishNlf) {
          throw "English.nlf not found in installed NSIS. Checked: $($candidates -join ', ')"
        }
        $outLocal = Join-Path -Path $destDirLocal -ChildPath "en-US.nlf"
        Copy-Item $englishNlf $outLocal -Force
        Write-Host "NSIS language file injected: $outLocal"
        if (!(Test-Path $outLocal)) { throw "Failed to prepare en-US.nlf at $outLocal" }
        # Also provide repository-local custom language file for Tauri customLanguageFiles
        $outRepo = Join-Path -Path $destDirRepo -ChildPath "en-US.nlf"
        Copy-Item $englishNlf $outRepo -Force
        Write-Host "NSIS custom language file prepared: $outRepo"
        if (!(Test-Path $outRepo)) { throw "Failed to prepare en-US.nlf at $outRepo" }

    - name: Build Tauri app
      working-directory: src-tauri
      run: |
        $pf86 = [Environment]::GetEnvironmentVariable('ProgramFiles(x86)')
        $pf = [Environment]::GetEnvironmentVariable('ProgramFiles')
        $candidates = @()
        if ($pf86) { $candidates += (Join-Path -Path $pf86 -ChildPath 'NSIS\Contrib\Language files\English.nlf') }
        if ($pf) { $candidates += (Join-Path -Path $pf -ChildPath 'NSIS\Contrib\Language files\English.nlf') }
        $englishNlf = $candidates | Where-Object { $_ -and (Test-Path $_) } | Select-Object -First 1
        if (-not $englishNlf) {
          $fallbackRepo = Join-Path -Path (Join-Path -Path (Get-Location) -ChildPath 'nsis') -ChildPath 'en-US.nlf'
          if (Test-Path $fallbackRepo) { $englishNlf = $fallbackRepo }
        }
        $job = Start-Job -ScriptBlock {
          param($english)
          $targetDir = Join-Path -Path $env:LOCALAPPDATA -ChildPath 'tauri\NSIS\Contrib\Language files'
          for ($i=0; $i -lt 300; $i++) {
            if (Test-Path $targetDir) {
              $out = Join-Path -Path $targetDir -ChildPath 'en-US.nlf'
              if (-not (Test-Path $out)) {
                if ($english -and (Test-Path $english)) { Copy-Item $english $out -Force }
              }
              if (Test-Path $out) { break }
            }
            Start-Sleep -Seconds 1
          }
        } -ArgumentList $englishNlf
        cargo tauri build --config tauri.conf.json
        Receive-Job $job -Wait | Out-Null
        Remove-Job $job -Force

    - name: List artifacts
      if: always()
      run: |
        Write-Host "=== Build Artifacts ==="
        $bundleDir = "src-tauri\target\release\bundle\nsis"
        if (Test-Path $bundleDir) {
          Get-ChildItem $bundleDir -Recurse -Include *.exe | ForEach-Object {
            Write-Host "$($_.FullName) - $([math]::Round($_.Length/1MB,2)) MB"
          }
        } else {
          Write-Host "NSIS bundle directory not found. Build may have failed."
          if (Test-Path "src-tauri\target\release") {
            Write-Host "Release directory contents:"
            Get-ChildItem "src-tauri\target\release" -File | Select-Object Name, Length
          }
        }

    - name: Upload NSIS
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: windows-nsis
        path: src-tauri/target/release/bundle/nsis/*.exe

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          src-tauri/target/release/bundle/nsis/*.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
