name: Build Windows EXE

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install Tauri CLI (v2)
      run: |
        cargo install tauri-cli --version ">=2.0.0,<3.0.0" --locked
        cargo tauri --version

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: src-tauri/target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

    - name: Install FFmpeg
      run: choco install ffmpeg -y --no-progress

    - name: Install NSIS
      run: choco install nsis -y --no-progress

    - name: Install frontend dependencies
      working-directory: frontend
      run: |
        npm ci
        if ($LASTEXITCODE -ne 0) {
          Write-Host "npm ci failed, falling back to npm install"
          npm install
        }

    - name: Build frontend
      working-directory: frontend
      run: npm run build

    - name: Build CPU and GPU variants
      run: |
        python -m pip install --upgrade pip setuptools wheel
        if (Test-Path "backend\requirements.runtime.txt") {
          pip install -r backend\requirements.runtime.txt
        } else {
          pip install -r backend\requirements.txt
        }
        pip install pyinstaller

        $ffmpegExe = Get-ChildItem "C:\ProgramData\chocolatey\lib\ffmpeg*" -Recurse -Include ffmpeg.exe -ErrorAction SilentlyContinue | Select-Object -First 1
        $ffprobeExe = Get-ChildItem "C:\ProgramData\chocolatey\lib\ffmpeg*" -Recurse -Include ffprobe.exe -ErrorAction SilentlyContinue | Select-Object -First 1
        if (-not $ffmpegExe) { throw "ffmpeg.exe not found under Chocolatey lib path" }
        if (-not $ffprobeExe) { throw "ffprobe.exe not found under Chocolatey lib path" }

        $cfg = Get-Content -Raw 'src-tauri\tauri.conf.json' | ConvertFrom-Json
        $productName = $cfg.productName
        $version = $cfg.version
        $artifactBase = 'src-tauri\target\release\dist'
        New-Item -ItemType Directory -Force $artifactBase | Out-Null
        $safeProduct = ($productName -replace '[^A-Za-z0-9_.-]', '_')

        foreach ($variant in @("cpu","gpu")) {
          Write-Host "=== Build variant: $variant ==="
          Push-Location backend
          try {
            pip uninstall -y torch torchvision | Out-Null
            if ($variant -eq "cpu") {
              pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
            } else {
              pip install torch torchvision --index-url https://download.pytorch.org/whl/cu121
            }
            if ($variant -eq "cpu") {
              pip install torchaudio==2.5.1+cpu --index-url https://download.pytorch.org/whl/cpu
            } else {
              pip install torchaudio==2.5.1+cu121 --index-url https://download.pytorch.org/whl/cu121
            }
            pyinstaller --clean --distpath dist backend.spec
            if ($LASTEXITCODE -ne 0) { throw "PyInstaller exited with code $LASTEXITCODE" }
          } finally { Pop-Location }

          New-Item -ItemType Directory -Force "src-tauri\resources" | Out-Null
          Copy-Item "backend\dist\superAutoCutVideoBackend.exe" "src-tauri\resources\" -Force
          Copy-Item $ffmpegExe.FullName "src-tauri\resources\ffmpeg.exe" -Force
          Copy-Item $ffprobeExe.FullName "src-tauri\resources\ffprobe.exe" -Force

          if (Test-Path "src-tauri\target\release") {
            Remove-Item "src-tauri\target\release" -Recurse -Force -ErrorAction SilentlyContinue
          }

          Push-Location src-tauri
          try {
            cargo tauri build --config tauri.conf.json --bundles nsis,msi
            if ($LASTEXITCODE -ne 0) { throw "Cargo tauri build exited with code $LASTEXITCODE" }
          } finally { Pop-Location }

          $variantOut = Join-Path $artifactBase $variant
          $installersOut = Join-Path $variantOut "installers"
          New-Item -ItemType Directory -Force $installersOut | Out-Null
          foreach ($pair in @(
            @{ dir = 'src-tauri\target\release\bundle\nsis'; filter = '*.exe'; bundle = 'nsis' },
            @{ dir = 'src-tauri\target\release\bundle\msi';  filter = '*.msi'; bundle = 'msi' }
          )) {
            if (Test-Path $pair.dir) {
              Get-ChildItem -Path $pair.dir -Filter $pair.filter -ErrorAction SilentlyContinue | ForEach-Object {
                $ext = $_.Extension
                $dst = Join-Path $installersOut ("${safeProduct}_v${version}_${variant}_${($pair.bundle)}${ext}")
                Copy-Item -Force $_.FullName $dst
              }
            }
          }
        }

    - name: List artifacts
      if: always()
      run: |
        Write-Host "=== Build Artifacts ==="
        $dist = "src-tauri\target\release\dist"
        if (Test-Path $dist) {
          Get-ChildItem $dist -Recurse -Include *.exe,*.msi | ForEach-Object {
            Write-Host "$($_.FullName) - $([math]::Round($_.Length/1MB,2)) MB"
          }
        } else {
          Write-Host "dist directory not found."
        }

    - name: Upload installers
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ${{ github.event.repository.name }}-windows
        path: src-tauri/target/release/dist/**/installers/*

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          src-tauri/target/release/dist/**/installers/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
