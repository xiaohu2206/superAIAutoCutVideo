name: Build Windows EXE

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install Tauri CLI (v2)
      run: |
        cargo install tauri-cli --version ">=2.0.0,<3.0.0" --locked
        cargo tauri --version

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: src-tauri/target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

    - name: Install FFmpeg
      run: choco install ffmpeg -y --no-progress

    - name: Install NSIS
      run: choco install nsis -y --no-progress

    - name: Install frontend dependencies
      working-directory: frontend
      run: |
        npm ci
        if ($LASTEXITCODE -ne 0) {
          Write-Host "npm ci failed, falling back to npm install"
          npm install
        }

    - name: Build frontend
      working-directory: frontend
      run: npm run build

    - name: Install Python dependencies
      working-directory: backend
      run: |
        python -m pip install --upgrade pip setuptools wheel
        if (Test-Path "requirements.runtime.txt") {
          pip install -r requirements.runtime.txt
        } else {
          pip install -r requirements.txt
        }
        pip install pyinstaller

    - name: Build Python backend
      working-directory: backend
      run: |
        pyinstaller --clean --distpath dist backend.spec

    - name: Create resources directory
      run: |
        New-Item -ItemType Directory -Path "src-tauri\resources" -Force
    - name: Copy FFmpeg binaries to resources
      run: |
        $ffmpegExe = Get-ChildItem "C:\ProgramData\chocolatey\lib\ffmpeg*" -Recurse -Include ffmpeg.exe -ErrorAction SilentlyContinue | Select-Object -First 1
        $ffprobeExe = Get-ChildItem "C:\ProgramData\chocolatey\lib\ffmpeg*" -Recurse -Include ffprobe.exe -ErrorAction SilentlyContinue | Select-Object -First 1
        if (-not $ffmpegExe) { throw "ffmpeg.exe not found under Chocolatey lib path" }
        if (-not $ffprobeExe) { throw "ffprobe.exe not found under Chocolatey lib path" }
        Copy-Item $ffmpegExe.FullName "src-tauri\resources\ffmpeg.exe" -Force
        Copy-Item $ffprobeExe.FullName "src-tauri\resources\ffprobe.exe" -Force

    - name: Copy backend to resources
      run: |
        Copy-Item "backend\dist\superAutoCutVideoBackend.exe" "src-tauri\resources\" -Force

    - name: Verify setup
      run: |
        Write-Host "=== Verification ==="
        Write-Host "Frontend build:"
        Test-Path "frontend\dist" | Out-Host
        Write-Host "`nBackend in resources:"
        Test-Path "src-tauri\resources\superAutoCutVideoBackend.exe" | Out-Host
        Write-Host "`nFFmpeg in resources:"
        Test-Path "src-tauri\resources\ffmpeg.exe" | Out-Host
        Test-Path "src-tauri\resources\ffprobe.exe" | Out-Host
        Write-Host "`nFFmpeg:"
        ffmpeg -version | Select-Object -First 1

    - name: Verify Tauri config file
      run: |
        Write-Host "=== Verify tauri.conf.json ==="
        if (Test-Path "src-tauri\tauri.conf.json") {
          $item = Get-Item "src-tauri\tauri.conf.json"
          Write-Host "Path: $($item.FullName)"
          Write-Host "Size: $($item.Length) bytes"
          if ($item.Length -eq 0) { throw "tauri.conf.json is empty" }
          Get-Content "src-tauri\tauri.conf.json" -Head 20 | ForEach-Object { Write-Host $_ }
        } else {
          throw "src-tauri\\tauri.conf.json not found"
        }

    - name: Show Tauri config header bytes
      run: |
        Write-Host "=== Hex dump (first 16 bytes) ==="
        Format-Hex "src-tauri\tauri.conf.json" | Select-Object -First 3

    - name: Clean previous Windows bundles
      run: |
        Write-Host "=== Clean previous bundles ==="
        $nsisDir = "src-tauri\target\release\bundle\nsis"
        $msiDir  = "src-tauri\target\release\bundle\msi"
        if (Test-Path $nsisDir) {
          Write-Host "Removing NSIS bundle directory: $nsisDir"
          Remove-Item $nsisDir -Recurse -Force -ErrorAction SilentlyContinue
        }
        if (Test-Path $msiDir) {
          Write-Host "Removing MSI bundle directory: $msiDir"
          Remove-Item $msiDir -Recurse -Force -ErrorAction SilentlyContinue
        }

    - name: Build Tauri app
      working-directory: src-tauri
      run: |
        cargo tauri build --config tauri.conf.json

    - name: List artifacts
      if: always()
      run: |
        Write-Host "=== Build Artifacts ==="
        $bundleDir = "src-tauri\target\release\bundle\nsis"
        if (Test-Path $bundleDir) {
          Get-ChildItem $bundleDir -Recurse -Include *.exe | ForEach-Object {
            Write-Host "$($_.FullName) - $([math]::Round($_.Length/1MB,2)) MB"
          }
        } else {
          Write-Host "NSIS bundle directory not found. Build may have failed."
          if (Test-Path "src-tauri\target\release") {
            Write-Host "Release directory contents:"
            Get-ChildItem "src-tauri\target\release" -File | Select-Object Name, Length
          }
        }

    - name: Upload NSIS
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: superAIAutoCutVideo-1.0.2
        path: src-tauri/target/release/bundle/nsis/*-setup.exe

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          src-tauri/target/release/bundle/nsis/*-setup.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
