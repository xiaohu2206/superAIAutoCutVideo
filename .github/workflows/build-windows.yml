name: Build Windows EXE

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: backend/requirements.txt

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-pc-windows-msvc

    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: src-tauri

    - name: Install FFmpeg
      run: |
        choco install ffmpeg -y
        echo "C:\ProgramData\chocolatey\lib\ffmpeg\tools\ffmpeg\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Verify FFmpeg installation
      run: ffmpeg -version

    - name: Install frontend dependencies
      working-directory: frontend
      run: npm ci

    - name: Build frontend
      working-directory: frontend
      run: npm run build

    - name: Install Python dependencies
      working-directory: backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build Python backend with PyInstaller
      working-directory: backend
      run: |
        pyinstaller --onefile --name superAutoCutVideoBackend --hidden-import=uvicorn.logging --hidden-import=uvicorn.loops --hidden-import=uvicorn.loops.auto --hidden-import=uvicorn.protocols --hidden-import=uvicorn.protocols.http --hidden-import=uvicorn.protocols.http.auto --hidden-import=uvicorn.protocols.websockets --hidden-import=uvicorn.protocols.websockets.auto --hidden-import=uvicorn.lifespan --hidden-import=uvicorn.lifespan.on --collect-all=cv2 --collect-all=numpy main.py

    - name: Create resources directory
      run: |
        if (!(Test-Path "src-tauri\resources")) {
          New-Item -ItemType Directory -Path "src-tauri\resources"
        }

    - name: Copy backend executable to resources
      run: |
        Copy-Item "backend\dist\superAutoCutVideoBackend.exe" "src-tauri\resources\" -Force

    - name: Verify backend executable
      run: |
        if (Test-Path "src-tauri\resources\superAutoCutVideoBackend.exe") {
          Write-Host "✓ Backend executable copied successfully"
          Get-Item "src-tauri\resources\superAutoCutVideoBackend.exe" | Format-List
        } else {
          Write-Error "✗ Backend executable not found"
          exit 1
        }

    - name: Build Tauri app
      working-directory: src-tauri
      run: |
        cargo tauri build --verbose

    - name: List build artifacts
      run: |
        Write-Host "=== Build Artifacts ==="
        if (Test-Path "src-tauri\target\release\bundle") {
          Get-ChildItem -Path "src-tauri\target\release\bundle" -Recurse -File | Where-Object { $_.Extension -in @('.exe', '.msi') } | ForEach-Object {
            Write-Host "Found: $($_.FullName)"
            Write-Host "  Size: $([math]::Round($_.Length / 1MB, 2)) MB"
          }
        }

    - name: Upload MSI installer
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: windows-msi-installer
        path: src-tauri/target/release/bundle/msi/*.msi
        if-no-files-found: warn

    - name: Upload NSIS installer
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: windows-nsis-installer
        path: src-tauri/target/release/bundle/nsis/*.exe
        if-no-files-found: warn

    - name: Upload portable executable
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: windows-portable-exe
        path: src-tauri/target/release/*.exe
        if-no-files-found: warn

    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          src-tauri/target/release/bundle/msi/*.msi
          src-tauri/target/release/bundle/nsis/*.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
