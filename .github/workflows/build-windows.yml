name: Build Windows EXE

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install Tauri CLI
      run: |
        cargo install tauri-cli --locked
        cargo tauri --version

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: src-tauri/target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

    - name: Install FFmpeg
      run: choco install ffmpeg -y --no-progress

    - name: Install frontend dependencies
      working-directory: frontend
      run: npm ci

    - name: Build frontend
      working-directory: frontend
      run: npm run build

    - name: Install Python dependencies
      working-directory: backend
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build Python backend
      working-directory: backend
      run: |
        pyinstaller --onefile `
          --name superAutoCutVideoBackend `
          --hidden-import=uvicorn.logging `
          --hidden-import=uvicorn.loops `
          --hidden-import=uvicorn.loops.auto `
          --hidden-import=uvicorn.protocols `
          --hidden-import=uvicorn.protocols.http `
          --hidden-import=uvicorn.protocols.http.auto `
          --hidden-import=uvicorn.protocols.websockets `
          --hidden-import=uvicorn.protocols.websockets.auto `
          --hidden-import=uvicorn.lifespan `
          --hidden-import=uvicorn.lifespan.on `
          --collect-all=cv2 `
          --collect-all=numpy `
          --noconfirm `
          main.py

    - name: Create resources directory
      run: |
        New-Item -ItemType Directory -Path "src-tauri\resources" -Force

    - name: Copy backend to resources
      run: |
        Copy-Item "backend\dist\superAutoCutVideoBackend.exe" "src-tauri\resources\" -Force

    - name: Verify setup
      run: |
        Write-Host "=== Verification ==="
        Write-Host "Frontend build:"
        Test-Path "frontend\dist" | Out-Host
        Write-Host "`nBackend in resources:"
        Test-Path "src-tauri\resources\superAutoCutVideoBackend.exe" | Out-Host
        Write-Host "`nFFmpeg:"
        ffmpeg -version | Select-Object -First 1

    - name: Build Tauri app
      working-directory: src-tauri
      run: cargo tauri build

    - name: List artifacts
      if: always()
      run: |
        Write-Host "=== Build Artifacts ==="
        Get-ChildItem "src-tauri\target\release\bundle" -Recurse -Include *.msi,*.exe | ForEach-Object {
          Write-Host "$($_.FullName) - $([math]::Round($_.Length/1MB,2)) MB"
        }

    - name: Upload MSI
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: windows-msi
        path: src-tauri/target/release/bundle/msi/*.msi

    - name: Upload NSIS
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: windows-nsis
        path: src-tauri/target/release/bundle/nsis/*.exe

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          src-tauri/target/release/bundle/msi/*.msi
          src-tauri/target/release/bundle/nsis/*.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
