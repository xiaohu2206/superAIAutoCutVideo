name: Build Windows EXE

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install Tauri CLI (v2)
      run: |
        cargo install tauri-cli --version ">=2.0.0,<3.0.0" --locked
        cargo tauri --version

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: src-tauri/target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

    - name: Install FFmpeg
      run: choco install ffmpeg -y --no-progress

    - name: Install NSIS
      run: choco install nsis -y --no-progress

    - name: Install frontend dependencies
      working-directory: frontend
      run: npm ci

    - name: Install Python dependencies
      working-directory: backend
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build Python backend
      working-directory: backend
      run: |
        pyinstaller --onefile `
          --name superAutoCutVideoBackend `
          --hidden-import=uvicorn.logging `
          --hidden-import=uvicorn.loops `
          --hidden-import=uvicorn.loops.auto `
          --hidden-import=uvicorn.protocols `
          --hidden-import=uvicorn.protocols.http `
          --hidden-import=uvicorn.protocols.http.auto `
          --hidden-import=uvicorn.protocols.websockets `
          --hidden-import=uvicorn.protocols.websockets.auto `
          --hidden-import=uvicorn.lifespan `
          --hidden-import=uvicorn.lifespan.on `
          --collect-all=cv2 `
          --collect-all=numpy `
          --noconfirm `
          main.py

    - name: Create resources directory
      run: |
        New-Item -ItemType Directory -Path "src-tauri\resources" -Force

    - name: Copy backend to resources
      run: |
        Copy-Item "backend\dist\superAutoCutVideoBackend.exe" "src-tauri\resources\" -Force

    - name: Verify setup
      run: |
        Write-Host "=== Verification ==="
        Write-Host "Frontend build:"
        Test-Path "frontend\dist" | Out-Host
        Write-Host "`nBackend in resources:"
        Test-Path "src-tauri\resources\superAutoCutVideoBackend.exe" | Out-Host
        Write-Host "`nFFmpeg:"
        ffmpeg -version | Select-Object -First 1

    - name: Verify Tauri config file
      run: |
        Write-Host "=== Verify tauri.conf.json ==="
        if (Test-Path "src-tauri\tauri.conf.json") {
          $item = Get-Item "src-tauri\tauri.conf.json"
          Write-Host "Path: $($item.FullName)"
          Write-Host "Size: $($item.Length) bytes"
          if ($item.Length -eq 0) { throw "tauri.conf.json is empty" }
          Get-Content "src-tauri\tauri.conf.json" -Head 20 | ForEach-Object { Write-Host $_ }
        } else {
          throw "src-tauri\\tauri.conf.json not found"
        }

    - name: Show Tauri config header bytes
      run: |
        Write-Host "=== Hex dump (first 16 bytes) ==="
        Format-Hex "src-tauri\tauri.conf.json" | Select-Object -First 3

    - name: Patch Tauri config for CI
      run: |
        Write-Host "=== Patching tauri.conf.json for GitHub Actions ==="
        $path = "src-tauri\tauri.conf.json"
        $content = Get-Content $path -Raw
        $newContent = $content -replace 'cnpm', 'npm'
        Set-Content $path $newContent
        Write-Host "Replaced 'cnpm' with 'npm' in tauri.conf.json"

    - name: Provide NSIS en-US language file
      run: |
        Write-Host "=== Preparing NSIS en-US language file ==="
        $destDir = "src-tauri\nsis"
        if (!(Test-Path $destDir)) { New-Item -ItemType Directory -Path $destDir -Force | Out-Null }
        $nsisDir = "${env:ProgramFiles(x86)}\NSIS"
        $englishNlf = Join-Path $nsisDir "Contrib\Language files\English.nlf"
        if (!(Test-Path $englishNlf)) {
          throw "English.nlf not found in installed NSIS at $englishNlf"
        }
        $out = Join-Path $destDir "en-US.nlf"
        Copy-Item $englishNlf $out -Force
        Write-Host "NSIS language file ready: $out"

    - name: Build Tauri app
      working-directory: src-tauri
      run: cargo tauri build --config tauri.conf.json

    - name: List artifacts
      if: always()
      run: |
        Write-Host "=== Build Artifacts ==="
        $bundleDir = "src-tauri\target\release\bundle\nsis"
        if (Test-Path $bundleDir) {
          Get-ChildItem $bundleDir -Recurse -Include *.exe | ForEach-Object {
            Write-Host "$($_.FullName) - $([math]::Round($_.Length/1MB,2)) MB"
          }
        } else {
          Write-Host "NSIS bundle directory not found. Build may have failed."
          if (Test-Path "src-tauri\target\release") {
            Write-Host "Release directory contents:"
            Get-ChildItem "src-tauri\target\release" -File | Select-Object Name, Length
          }
        }

    - name: Upload NSIS
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: windows-nsis
        path: src-tauri/target/release/bundle/nsis/*.exe

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          src-tauri/target/release/bundle/nsis/*.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
